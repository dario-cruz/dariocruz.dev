{"searchDocs":[{"title":"Kerberoasting: What You Need To Know","type":0,"sectionRef":"#","url":"/blog/Kerberoasting-Explained","content":"","keywords":"Kerberoasting Kerberos Active Directory Rubeus Hashcat","version":null},{"title":"Kerberos... What's that?â€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#kerberos-whats-that","content":" Kerberos is a network authentication mechanism that is used in Active Directory and other systems/environments. It was developed by Massachusetts Institute of Technology(MIT) in the last 1980's and is now the default authorization technology in Microsoft Windows, it has also been implemented in Apple OS, FreeBSD, UNIX, and Linux. Active Directory its self has the largest market share out of all IAM platforms so attackers target AD environments and attack Kerberos consistently, thus this is a good topic to learn about. 1  The main reason the protocol was developed in the first place, was to provide a way of securing authentication traffic on a given network, preventing threat actors from intercepting authentication transmissions, gaining unauthorized access. Back in the 1980's most authentication was transmitted in clear text over networks, making it easy for threat actors with network access to eavesdrop on traffic and obtain credentials.2  ","version":null,"tagName":"h2"},{"title":"Componentsâ€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#components","content":" Kerberos consists of a few interconnected parts that work together to offer a complete &amp; secure authentication and authorization protocol.  The Client: The end point that is requesting authentication to an app, service, or network. The client will send out a request to what is called the Key Distribution Center, with it's encrypted credentials and await a response back.Key Distribution Center: Handles the requests from clients for authentication, is comprised of 3 elements, which all tend to reside on the same server. They are the Authentication Server, Ticket Granting Server, and a Database. Authentication Server: Component of the KDC that receives client requests and provides successfully authenticated clients with a ticket known as a Ticket Granting Ticket (TGT). The TGT allows for authed clients to obtain other Service Tickets without having to re-enter credentials.Ticket Granting Server (TGS): Component of the KDC that is the distributor of Service Tickets to clients with a valid TGT, providing them access to specific services, apps, or networks.Database: Part of the KDC that contains entries of users and the associated services that they have access to. Also contains information related to the max validity duration for a ticket, max time a ticket may be renewed, password expiration date, etc.    ","version":null,"tagName":"h3"},{"title":"Kerberoastingâ€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#kerberoasting","content":" Okay so now that we have an understanding of how Kerberos works, we will move on to how threat actors carry out what is called Kerberoasting.  Kerberoasting is an attack that attempts to obtain the password hash of an Active Directory Service Account that has what is called a Service Principal Name (SPN). What is an SPN you might ask? Well, it is a Active Directory attribute that is used by Kerberos authentication mechanisms to associate a service instance with corresponding service account, providing access to said service. 3 4  ","version":null,"tagName":"h2"},{"title":"The Attackâ€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#the-attack","content":" The threat actor must first gain access to a domain user account via compromise, not a Domain Admin account, just a regular account, this then allows them to request a Kerberos service ticket from the TGS. This is done with the use of tools, most commonly Rubeus. Once the ticket is received from the KDC the threat actor stores the key for offline brute forcing. The ticket from the KDC contains an encrypted hash of the service accounts password.  Rubeus is a tool, written in C# that automates interaction and abuse of Kerberos authentication mechanisms. It has a host of options such as making Ticket Requests and Renewals, Ticket Forgery, Ticket Extraction and Harvesting. 5  So lets say that we wanted to use the tool to carryout our own testing, or make use of it for a capture the flag challenge. On Windows via PowerShell, the command to carry out Kerberoasting, using Rubeus, would be;  .\\Rubeus.exe kerberoast /outfile:results.txt   After obtaining the SPN values from Rubeus, threat actors then carry out offline brute forcing with tools like Hashcat or JohnTheRipper. In the case of hashcat, looking at the documentation for the command-line utility, there is a specific hash option designed for Kerberos 5 hashes, hash option 13100.And if we were to let's say use the result.txt file form the Rubeus output, you could use the below command to crack the hashes of the returned SPN's.  hashcat -m 13100 -a 0 wordlist.txt results.txt --outfile=&quot;cracked-spns.txt&quot;   The -m flag allows for specifying what hash type we would like to crack, and as stated previously 13100 is the value for the Kerberos hash type. The-a flag specifies the type of attack mode to use. It's followed by the value of 0 which is &quot;Straight Mode&quot;. Straight Mode uses a single wordlist, as you can see by flag and value having wordlist.txt specified after it. Next is the target file that contains the hash, in our case it is results.txt. At the end we have --outfile which directs hashcat to save the output to a specified file, in this case cracked-spns.txt, formatting can also be changed for the output file via --outfile-format as well. 6  ","version":null,"tagName":"h3"},{"title":"Attack Chain Visualizedâ€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#attack-chain-visualized","content":" Below I have included a graphic of the entire Kerberoasting attack chain.    ","version":null,"tagName":"h3"},{"title":"Detectionâ€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#detection","content":" Kerberoasting attacks can be detected via the monitoring of Windows Event Code: 4769, which is the Windows event code that corresponds to a Kerberos ticket being requested. In the logs for this event code there are a few fields to take not of, specifically the Account Name, Service Name, Client Address, and the Ticket Encryption Type. The value for the Ticket Encryption Type is an important, the hex values represent the type of encryption being used for the request and could tip us off to a potential attack.  Below is a table of common encryption types and their strengths.  Hex code\tEncryption Type\tDescription0x17\tRC4_HMAC\tWeak Encryption, Commonly Used for Kerberoasting attacks 0x12\tAES256_CTS_HMAC_SHA1_96\tStrong encryption, preferred for modern environments. 0x11\tAES128_CTS_HMAC_SHA1_96\tStrong but less secure then AES256. 0x01\tDES_CBC_CRC\tDeprecated/Weak encryption. 0x02\tDES_CBC_MD5\tDeprecated/Weak encryption. 0x03\tDES3_CBC_SHA1\tStronger then both DES encryption algorithms but is not commonly used in modern environments.  Take note that any Kerberos request that uses the RC4_HMAC encryption protocol is potentially an indicator of attack or compromise.  Also, we need to note that if any of the legacy encryption methods are left enabled on the KDC server, attackers could carryout a downgrade attack on the Kerberos system, effectively forcing the authentication/authorization protocol to use a weaker level encryption allowing for threat actors to more easily crack the SPN hash. ðŸ˜¬  Lets say that we wanted to do an SPL query in Splunk for Kerberoasting, targeting the Event 4769 and the Ticket Encryption Value of 0x17, the query would look like this:  index=&lt;target-index&gt; EventCode=4769 EncryptionType=0x17   ","version":null,"tagName":"h3"},{"title":"Preventionâ€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#prevention","content":" The goal of Kerberoasting attacks is the theft of service account credentials and the eventual compromise of the AD Doman, allowing threat actors to gain a foot hold in an organizations environment and carry out further malicious actions. Due to these factors, prevention of Kerberoasting attacks should take a multi-faceted approach. Below are some methods to protect against Kerberoasting attacks:  Use of strong &amp; complex Service Account passwords &amp; the updating of said passwords on a regular cadence. 7Restriction of Service Principal Name (SPN) Exposure via limiting SPN registration and using Managed Service Accounts. 8Enforcement of strong encryption types, threat actors will attempt to push the protocol to downgrade the encryption, if these lower level encryption standards are enabled, the domain will be left vulnerable to Kerberoasting attacks. 8Implementing Monitoring and Auditing of Kerberos Ticket Requests, this will allow for alerting on unusual requests and audits will find unusual patterns that could indicate attack or compromise. 9  ","version":null,"tagName":"h3"},{"title":"Conclusionâ€‹","type":1,"pageTitle":"Kerberoasting: What You Need To Know","url":"/blog/Kerberoasting-Explained#conclusion","content":" And with that, you know have a pretty good understanding of Kerberos &amp; Kerberoasting. How threat actor target Kerberos and Active Directory in an attempt to compromise a Service Account, and potentially over parts of the domain after the initial compromise.  You also know now how to detect and defend from these types of attacks but, there is always more to learn and more to dig into and understand. As my learning progresses I will update this article with other bits of information I find related to Kerberoasting.  Thank you for reading! ðŸ˜Ž    Footnotesâ€‹ https://www.simplilearn.com/what-is-kerberos-article#:~:text=This%20process%20uses%20shared%20secret,against%20eavesdropping%20and%20replay%20attacks. â†© https://www.techtarget.com/searchsecurity/definition/Kerberos â†© https://www.crowdstrike.com/en-us/cybersecurity-101/cyberattacks/kerberoasting/ â†© https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names â†© https://github.com/GhostPack/Rubeus â†© https://hashcat.net/wiki/ â†© https://www.semperis.com/blog/protecting-active-directory-from-kerberoasting/ â†© https://www.microsoft.com/en-us/security/blog/2024/10/11/microsofts-guidance-to-help-mitigate-kerberoasting/ â†© â†©2 https://cymulate.com/cybersecurity-glossary/kerberoasting/ â†© ","version":null,"tagName":"h2"},{"title":"Loggy (HTB-Sherlock)","type":0,"sectionRef":"#","url":"/blog/Loggy-Sherlock","content":"","keywords":"Hack The Box Sherlock Loggy malware analysis incident response","version":null},{"title":"Scenarioâ€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#scenario","content":" Janice from accounting is beside herself! She was contacted by the SOC to tell her that her work credentials were found on the dark web by the threat intel team. We managed to recover some files from her machine and sent them to the our REM analyst.  ","version":null,"tagName":"h2"},{"title":"The Filesâ€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#the-files","content":" For this Sherlock we are provided with a zip file that contains some image files taken the users computer, the malicious file in a zip file, and a text file named, keylog.txt.    The danger.txt file just has some warnings about the malicious windows executable in danger.zip. I went ahead and extracted the malicious file onto my Kali Linux VM and took a look at the first task in the Sherlock.  ","version":null,"tagName":"h2"},{"title":"Task 1â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-1","content":" What is the SHA-256 hash of this malware binary?  Makes sense that the first objective would be to get the hash of the file. The SHA-256 hash can be used along with VirusTotal to check and see if the file matches with any other known malware samples.  I went ahead and obtained the SHA-256 hash via using the sha256sum cli utility, already preinstalled on the Kali Linux VM.    As you can see from the screenshot above the SHA-256 hash of the malicious file, Loggy.exe is 6acd8a362def62034cbd011e6632ba5120196e2011c83dc6045fcb28b590457c.    ","version":null,"tagName":"h2"},{"title":"Task 2â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-2","content":" What programming language (and version) is this malware written in?  Hmm, okay for this I attempted to use the strings utility. The output from running the strings command without any flags/options produced a large number of results. To target this a little more I decided to make use of the -n flag which tells strings to return only strings of a specific length. I ran the command strings -n 6 loggy.exe and took a look at the results.    As you can see we have a string found in the file stating Go Build ID:..... It looks like this piece of malware may have been written in Golang. I proceeded to run strings again, this time using grep to filter for golang. This also produced a large list of strings that had golang contained in them.    The most notable string found was the one highlighted above. Looks like the malware has a dependency for Golang v0.11.0. I attempted to input this as the task flag but, it was not correct.  ","version":null,"tagName":"h2"},{"title":"Golang Researchâ€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#golang-research","content":" At this point I started to research how Golang is installed on Windows environments. What are the folder paths where the current versions of Golang are installed? Would they be referenced by the malicious software and show up as a string? Only one way to find out. I found this page, which details how to manage multiple versions of Golang on a system.  I found this line interesting, go install golang.org/dl/go1.10.7@latest. It looks like Golang versions are referenced in the go1.xx.xx format. We can use this with grep to filter for strings that may contain the version information.  Running the strings utility with grep looking for go1, the results returned are of a smaller size and we now know the version of Golang used by the malware, go1.22.3 and the flag of which being Golang 1.22.3.      ","version":null,"tagName":"h3"},{"title":"Task 3â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-3","content":" There are multiple GitHub repos referenced in the static strings. Which GitHub repo would most likely suggest the ability of this malware to exfiltrate data?  So, we need to look at the GitHub repos that are showing up as strings in our malware sample. While I was scrolling through the strings output during the first tasks, I did see a long list of repos that the malware had in its code. Most likely these are used either to download or upload data for malicious functions.  First command I used to filter for repos was the following.  strings loggy.exe | grep github   Looking at the results, I found some strings that included the url github.com/jlaffaye/ftp followed by *(ServerConn), and in some strings *(dialOptions).    I did a google search for the golang *(ServerConn) and got the following.  In Go's net/http package, *(ServerConn) represents a pointer to the ServerConn type. This type is an unexported struct responsible for managing the state of a single client connection on the server-side. It handles tasks such as reading requests, writing responses, and managing the connection's lifecycle.  It's a function in one of the Golang packages that is able to establish and maintain connections. This coupled with the url github.com/jlaffaye/ftp, indicates that the malware is attempting connections to a remote location which facilitates data exfiltration.    ","version":null,"tagName":"h2"},{"title":"Task 4â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-4","content":" What dependency, expressed as a GitHub repo, supports Janiceâ€™s assertion that she thought she downloaded something that can just take screenshots?  The answer to this task, I actually saw in looking for the answer to task 3. There were some GitHub repo strings that referenced github.com/kbinani/screenshot/internal/util.CreateImage. Let's use a grep filter and search for strings that contain screenshot and take a look.  strings loggy.exe | grep github | grep screenshot   I got the following output confirming the usage of github.com/kbinani/screenshot.    Looking at the Github repo website it explains that it hosts a library that provides screenshot functionality in Golang.      ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-5","content":" Which function call suggests that the malware produces a file after execution?  For this task I started off with doing some research on Golang and how it calls functions, leveraging the knowledge that the malware was written in Golang. In most programming languages the syntax for creating a file is normally write and may include the word file. I filtered the strings output with the command below:  strings loggy.exe | grep -i write | grep -i file     Looking at the tail end of the output, we can see a few function calls that have WriteFile as a part of them but, there is also a standalone string WriteFile, this looked to be the function call we are looking for. I entered it in the flag box and it was the answer.    ","version":null,"tagName":"h2"},{"title":"Task 6â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-6","content":" You observe that the malware is exfiltrating data over FTP. What is the domain it is exfiltrating data to?  The task is pretty straight forward, we need to find the hostname that the FTP function is connecting to and exfiltrating data/images to. I attempted to use grep to filter for a few keywords which included, hostname, IP, target, and address. I started to get the feeling that I was missing something. Looking at what the task asks of you for, we know that the malware is making use of the FTP protocol. The protocol uses the ports 21 and 20. Port 21 being for command/control and port 20 for data transfer. I proceeded to filter the output of the strings command, looking for both ports. Normally when a port is referenced along with an ip or hostname there is a :, between the address and the port like 192.168.1.189:21 or 192.168.1.189:20. I ran the command below, looking for any strings containing :21and found the following:  strings Loggy.exe | grep :21     We are returned a string that contains gotthem.htb:21. The domain being gotthem.htb.    ","version":null,"tagName":"h2"},{"title":"Task 7â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-7","content":" What are the threat actorâ€™s credentials?  Okay so for this task I attempted to filter for keywords like username, password, pwd, user, usr, etc, but I did not find anything of note. For the next phase of analysis, I went ahead and moved to a Windows VM to use reverse engineering software to complete a deeper analysis.  The Windows VM that I am working in was setup using FlareVM, a really handy tool for creating a malware analysis/reverse engineering platform for investigations. If you want to read more about FlareVM and how to set it up proceed over here to the official GitHub page.  Here we are in our FlareVM ready to go.    Lets now check for the presence of credentials in the malware's assembly code. For this task I am making use of a tool called Ghidra, which was created and used by the NSA as a reverse engineering framework.  I proceeded to make a new project and import our malware sample loggy.exe. Taking a look a the symbol tree we can see a list of functions that have been auto-named by Ghidra. You can see a host of functions related to FTP functionality, which we know is how the malware is exfiltrating data.  Digging into the functions and their logic, I was able to find a function, main.sendFilesViaFTP that referenced the credentials that the malware was using for it's FTP communications, username:NottaHacker &amp; password: Cle@rtextP@ssword.      ","version":null,"tagName":"h2"},{"title":"Task 8â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-8","content":" What file keeps getting written to disk?  Pretty straight forward question. Lets dive into the disassembled code to get a look at what the malware is writing to the disk. We should also note that the malware sample was provided along with some screenshots what looks to be a keylogger dump file named keylog.txt, so these filenames could be an easy entry point to confirm what files are constantly being written.  Diving back into Ghidra I started my search/investigation from the vantage point of the keylog.txt file. Looking at the contents of the file it looks like the malware is logging keycodes to this file. In theory, if the malware is indeed logging keystrokes as keycodes to this file, then the malware will have to constantly and continuously write to this file many times over.    With this hypothesis in mind I searched for defined strings that contained the filename of keylog.txt and got some hits.    The above image shows that the auto named variable s_keylog.txt_00650309 is storing the string value of keylog.txt the variable is also referenced by some functions as well. We can double-click on these functions and follow their execution to discern behavior/actions.  Following on and checking the top function, main.main:005f325e, I can see that the variable is accessed and it looks like an OS function is invoked for opening and accessing the file.    Further down the function we can also see what looks to be some error handling logic, in case the malware can not access/write to the keylog.txt file. Looks like we might be on the correct path to the answer.    Checking the other two functions main.sendFilesViaFTP:005f3c64(*) &amp; main.sendFilesViaFTP:005f3d91(*). They also reference the keylog.txt string, before invoking FTP functions, facilitating data exfiltration.        So, with all of this collected data and insight, I went ahead and input keylog.txt as the answer to the flag, which was correct.    ","version":null,"tagName":"h2"},{"title":"Task 9â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-9","content":" When Janice changed her password, this was captured in a file. What is Janice's username and password?  Alright so from the previous task we know that the malware is logging keystrokes to the keylog.txt file. We also know that there are keycodes and characters present in the file as well.  I did some searching around for a tool to convert keycodes to characters but, could not find a tool that fit my needs. This is where I turned to ChatGPT to analyze the contents of the keylog.txt file and provide some insights/results.    ChatGPT provided a nice break down and explanation of the keycodes and their value. It also provided translations of the keycodes, providing text we can use to discern the password logged.  We know that the user's name is Janice but, there are a few options presented for her password, PASSWORD, PAAAASASSASSSSSWWWWOOOOORRRRDDDD, PASSWORD123, and PASSWORD.TTTTTXXXXXTTTTT. The correct combination being janice:password123.    ","version":null,"tagName":"h2"},{"title":"Task 10â€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#task-10","content":" What app did Janice have open the last time she ran the &quot;screenshot app&quot;?  This task is straightforward. Included in the zip file for the sherlock is a series of 4 image files. Looking at the sequence of images we can see that the user had the Solitaire app open the last time she ran the malware.        ","version":null,"tagName":"h2"},{"title":"Key Takeawaysâ€‹","type":1,"pageTitle":"Loggy (HTB-Sherlock)","url":"/blog/Loggy-Sherlock#key-takeaways","content":" FlareVM is a really good resource for setting up reverse engineering machines. With its comprehensive list of tools and utilities it makes the task of reverse engineering &amp; malware analysis that much more easy.strings &amp; grep can be useful in passive analysis of malware. When used in conjunction they allow for filtering and gathering information about said malware. This facilitates deeper investigation and understanding of malware behavior.Ghidra is a reverse engineering framework developed by the NSA. It provides much of the same functionality as another popular tool IDA , decompiling of Windows Portable Executable files, the ability to see function logic and defined variables, etc. Ghidra is also open-source compared to IDA which is proprietary and has a pro version. ","version":null,"tagName":"h2"},{"title":"Learning Linux with Arch","type":0,"sectionRef":"#","url":"/blog/LearningLinuxArch","content":"","keywords":"Linux Arch Linux terminal fdisk GRUB","version":null},{"title":"Why Linux & Why Archâ€‹","type":1,"pageTitle":"Learning Linux with Arch","url":"/blog/LearningLinuxArch#why-linux--why-arch","content":" Linux is the OS of choice for all tech infrastructure. You would be hard pressed to find any organization that does not use Linux in some way to offer websites and/or services. Linux is king when it comes to the back-end of most of the internet as well.  ","version":null,"tagName":"h2"},{"title":"Arch Linuxâ€‹","type":1,"pageTitle":"Learning Linux with Arch","url":"/blog/LearningLinuxArch#arch-linux","content":" Arch Linux has been around since 2002 and has made a reputation for being a barebones, set it up yourself, no bloat version of Linux. Users of Arch are required to actively learn and manage the setup of the OS.  The inspiration for this project and practical learning Linux has come from a youtuber that I have watched in passing named Mischa Van Den Burg. See the video below for yourself.    ","version":null,"tagName":"h3"},{"title":"Installationâ€‹","type":1,"pageTitle":"Learning Linux with Arch","url":"/blog/LearningLinuxArch#installation","content":" Getting started with Arch is fairly simple, we grab the ISO image from the Arch website, either using BitTorrent to download or using one of the provided mirrors for your region. For my purposes I will be installing Arch in a VirtualBox VM.  I will also be following/using the official Arch documentation, which can be found here if you would like to follow along.  I provisioned the VM with 2 CPU cores, 4gb of RAM, and 70gb of storage space, which should be enough for doing a complete install. I booted the virtual machine to the iso image and we are present with a terminal with root access.    ","version":null,"tagName":"h2"},{"title":"Setting up the Filesystemâ€‹","type":1,"pageTitle":"Learning Linux with Arch","url":"/blog/LearningLinuxArch#setting-up-the-filesystem","content":" Before we actually install Arch, we need to prep the storage device, setting up partitions and the filesystem.  The first steps in doing this are to verify the boot mode which can be UEFI or plain old BIOS.    As you can see I ran the command cat /sys/firmare/efi/fw_platform_size and as you can see from the output of the terminal in the image above, this returned no results. According to the Arch wiki if no file or directory is found from catting this directory, then most likely we are running in BIOS mode.  Next I tested network connectivity, doing an ip link to ensure that my virtual ethernet link was up, ifconfig to check and see if we successfully obtained network configuration via DHCP, and also completed a ping ping.archlinux.org to verify that we can access/traverse the outside internet.    Having our network connectivity confirmed, let's update the time so that we have no networking issues related to time sync to do this I ran the command, timedatectl.    Partitioningâ€‹  Lets take a look at the disks that we have to work with. In Linux we do this via the fdisk utility, with the complete command being fdisk -l The -l at the end being the flag that designates for the tool to list out all of the drives that are found on the host system.    We can see from the output that our main QEMU disk is present and is reporting the correct size, being 70gb.  Our VM will be using the MBR and the regular BIOS for booting so the partitions on the VM will be simpler than if we were to use UEFI, which needs its own dedicated /boot partition.  For our use case we will be creating the following:  1x SWAP Partition, Size 10gb.1x Root Partition, Size 60gb.  In order to actually make these partitions we will again use the tool fdisk. If we look at the image from the previous step, we can see that our VM drive, the QEMU one, has the disk name of /dev/sda. We will use this with fdisk to target and partition the correct drive.  Full command to run == fdisk /dev/sda  When we run the command we are brought to an interactive prompt.    Since no commands we can use are displayed I hit m to show the list of available commands/options.    Initially when we ran the fdisk command targeting our VM drive, we received a message stating that no partition table had been created. I went ahead and ran the option for creation of the partition table for our drive, which is o in fdisk.    And now lets create the root partition. Using the fdisk option n, we can create a new partition    Selecting P for the primary I created the primary partition for Arch to be installed. I gave the primary partition 60gb of storage.  Then I created second primary partition, this one being 10gb in size.    Since I created both partitions as Linux partitions, I went back and converted the second 3gb partition to Linux Swap. Effectively setting up a swap partition for Arch to use.      And above we have both of our partitions ready to go. Note that we do not need any partition for MBR, if we were making use of GPT or UEFI, we would need to setup a dedicated partition for these boot mechanisms.    The now, before we exit the fdisk utility, we need to apply the changes that we just made. I displayed the help menu again to get the command to &quot;write&quot; the changes to the disk.    Formattingâ€‹  Now, with our partition table and partitions set, we need to format them in preparation for the OS installation.  /dev/sda1 is our root file system for Arch, thus it will need to be formatted as ext4./dev/sda2 is our swap partition and will need to be formatted as swap.  Below are the commands that I ran to format each of the partitions.  mkfs.ext4 /dev/sda1 mkswap /dev/sda2     Mountingâ€‹  Here we are mounting the now partitioned and formatted file systems. This will make them available to the temporary Arch OS for installation of the permanent Arch OS.  I will also enable our swap filesystem via the command below.    With that, we now have our file system created and ready for the OS install.  ","version":null,"tagName":"h3"},{"title":"Mirrors & Packagesâ€‹","type":1,"pageTitle":"Learning Linux with Arch","url":"/blog/LearningLinuxArch#mirrors--packages","content":" I adjusted the mirrors in /etc/pacman.d/mirrorlists moving all of the United States based mirrors to the top of the list as that is where I am currently located. Since these are geographically closer to me, we should receive good throughput network wise as there is less network traversal taking place.    Microcodeâ€‹  With our mirrors for the package repositories pointing to what is locally available. we can proceed with installation of microcode updates. Microcode is an intermediary layer between the CPU and the instruction set of the computer, more can be learned about it here.  Since we are running this installation of Arch Linux in a VM, which is emulating an x86/x64 based CPU, I will opt for installing the intel-based microcode.  Below is the complete command so far, more packages will be added to the command before executing:  pacstrap -K /mnt base linux linux-firmware intel-ucode   Userspace Utilsâ€‹  According to the Arch wiki we should install some filesystem tools. These will aid in file system creation and management of raid and lvm after install. I have selected a few that I think will be needed and updated the package install command.  pacstrap -K /mnt exfat-utils e2fsprogs hfsprogs ntfs-3g xfsprogs zfs-utils lvm2 mdadm   Network Utilsâ€‹  On our new system we will need networking capabilities(obviously), so I added the networkmanager package to the full pacstrap command along with the addition of mn-connection-editor &amp; network-manager-applet. Both of which provide graphical elements for network configuration/monitoring.  pacstrap -K /mnt networkmanager mn-connection-editor network-manager-applet   Console Text Editorsâ€‹  Linux is primarily based on text, every setting, configuration, as well as other elements, are based in text so it is essential that we have some basic way to edit forms of text from the command line. I have included nano &amp; vim.  pacstrap -K /mnt nano vim   Documentation Packagesâ€‹  Anyone that has had extended time in the Linux command-line will know that man pages are key for troubleshooting and general up keep of your system. They make learning &amp; understanding of CLI tools simple. For this install I will be adding man &amp; info to the list of packages to be bootstrapped before OS installation.  pacstrap -K /mnt man-db man-pages texinfo   Running pacstrapâ€‹  Running the complete command you can observe that most of the packages strapped correctly but, some errored out with &quot;error target not found&quot;.  For the linux-firmware package I had made a typo in the package name.hfsprogs is not available on the arch image according to the matrix found on this page.zfs-utils is not available on the arch image and can be installed after OS install.texinfo failed to install due to typo in the package name, which has been fixed.    And with that, we have all of the needed packages for our Arch Linux installation.  ","version":null,"tagName":"h3"},{"title":"System Configurationâ€‹","type":1,"pageTitle":"Learning Linux with Arch","url":"/blog/LearningLinuxArch#system-configuration","content":" Next we will start to configure the system environment. There are a few items on the list that need to be addressed and the first of which is Fstab  Fstabâ€‹  Fstab is a service that acts as the file system table, it is used for automatically mounting file systems. We will make use of genfstab to generate an fstab file using the below command.  genfstab -U /mnt &gt;&gt; /mnt/etc/fstab     Changing Root for Further Configâ€‹  In order to complete the rest of the configuration process for the Arch install, we need to change over to the root account on the permanent file system and make some adjustments. In order to accomplish this we run the command below:  arch-chroot /mnt     Adjusting Local Timeâ€‹  Below are the commands used to adjust local time. I changed my time zone over to EST.  ln -sF /usr/share/zoneinfo/EST /etc/localtime hwclock --systohc   We are effectively using the Linux &quot;softlink&quot;/symbolic link function to reference the EST zone info from /etc/localtime. Then with hwclock --systohc we are syncing the hardware clock of our VM to the system/software clock, adjusting the hardware clock to match the software/system clock we just adjusted to EST time.  Localizationâ€‹  Moving on, lets now setup our keyboard layout and localization for dates, currency, etc. In order to do this I will be running the command localectl set-locale LANG=en_US.UTF-8. Then I ran the command locale to list out all of the localization settings that have been applied.  localedef --list-archive localectl set-locale LANG=en_US.UTF-8     Network Hostnameâ€‹  Time to define the hostname for our Arch install. To accomplish this we need to create a file in /etc/hostname and add our designated hostname there, inside of that file. I had to find a work around to accomplish this as nano is not installed on our Arch system yet. I made use of the redirects to echo the hostname into the file after creation.    Install &amp; Config GRUBâ€‹  This step is very important. GRUB handles the booting of our Arch install, if we do not install and configure it, we will not be able to boot to the OS after completion of install. To do this I used pacman to install the grub bootloader.  pacman -S grub     I then proceeded to apply the grub install to our install drive. Note that I said drive and not partition, grub needs to be installed on the entire drive and not just the partition that we will be using as our main for the OS.  grub-install /dev/sda     With grub applied to the drive, we need to generate a configuration file, grub has a built in command for this which is grub-mkconfig. We will point this tool to the file path /boot/grub/grub.cfg using the -o flag, without this flag the config would just be output to the terminal.  grub-mkconfig -o /boot/grub/grub.cfg     Network Managerâ€‹  I will be installing the networkmanager tool as well. This is a suite of tools that aid in network connectivity on Linux, Arch included. Using pacman to install and then using systemctl to enable the service on our Arch install.    Setting Root Passwordâ€‹  And now for the final part before rebooting and completing our base installation, which will be setting the root password for our Arch OS.    Super simple, just run the passwd tool and then enter &amp; confirm the new password and it is applied to the root account, of which we are currently logged into.  Time to Rebootâ€‹    And with that we are finished with the base installation of Arch Linux, though we still do not have a GUI/desktop environment installed, we have a basic Linux OS as a base on which to build. In order to confirm our changes and boot into the OS we just setup/configured the only last step is to reboot.  I will be following the Arch wiki's recommendation to unmount all of the partitions.    And finally here we are after reboot, successfully booted into Arch Linux.    From here we can continue to build out the system, adding various tools and functionality as well as a graphical interface. Keep tabs on the blog for the next post in the series. ","version":null,"tagName":"h3"},{"title":"Campfire 1 (HTB-Sherlock)","type":0,"sectionRef":"#","url":"/blog/Campfire1-Sherlock","content":"","keywords":"Hack The Box Sherlock Campfire Kerberoasting log analysis","version":null},{"title":"The Scenarioâ€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#the-scenario","content":" Alonzo Spotted Weird files on his computer and informed the newly assembled SOC Team. Assessing the situation it is believed a Kerberoasting attack may have occurred in the network. It is your job to confirm the findings by analyzing the provided evidence. You are provided with: 1- Security Logs from the Domain Controller 2- PowerShell-Operational Logs from the affected workstation 3- Prefetch Files from the affected workstation  ","version":null,"tagName":"h2"},{"title":"The Filesâ€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#the-files","content":" I took a look at the file confirming what was stated in the scenario of the investigation. We have a folder named Triage with two folders inside named, Domain Controler &amp; Workstation. The Domain Controller folder has a single .evtx file named SECURITY-DC. The Workstation folder contains another .evtx file named PowerShellOperational and a folder that contains all of the Windows prefetch files taken at the time of attack.  ","version":null,"tagName":"h2"},{"title":"Task 1â€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#task-1","content":" Analyzing Domain Controller Security Logs, can you confirm the date &amp; time when the Kerberoasting activity occurred?  Let's take a look at the event log file that is present in the Domain Controller folder. Looking through the log file, and using information from my notes and also my article on Kerberoasting, we should be looking for the event code 4769 which signifies a Kerberos ticket is being requested. We also need to take a look at the method of encryption that is used in this specific event as threat actors will attempt to downgrade the encryption standard used, in order to offline brute force the hash of the password.  In the logs I can see that there are a number of Kerberos ticket requests, most of which make use of AES256_CTS_HMAC_SHA1_96, which is standard for modern AD environments.  Looking further we can see a suspicious ticket request at 5/20/2024 11:18:09 PM that stands out from the rest.  Here are the indicators:  Time of ticket request is off hours from business operations. (How's burning the midnight oil?)Ticket request encryption type is 0x17 which is the value for RC4_HMAC which is commonly used by threat actors for Kerberoasting.The ticket being requested is for the MSSQL services, which if granted could lead to data exfiltration or ransomware attacks.  So now we have time time and date that the Kerberoasting attack happened, which is 5/20/2024 11:18:09 PM but, there is one more step that we have to do. We need to convert the time the event occurred to UTC as Windows Event Viewer converts all log times to that machine's local time.  Task Flag: 2024-05-21 03:18:09  ","version":null,"tagName":"h2"},{"title":"Task 2â€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#task-2","content":" What is the Service Name that was targeted?  The flag for this task is present in the same event that we took a look at, detailing the start of the Kerberoasting attack.    Task Flag: MSSQLService  ","version":null,"tagName":"h2"},{"title":"Task 3â€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#task-3","content":" It is really important to identify the Workstation from which this activity occurred. What is the IP Address of the workstation?  Looking again at the same event log, towards the top of the event details we can see network information for the machine that initiated the request. Windows logs both the IPv6 and IPv4 addresses separated by an :.    Task Flag: 172.17.79.129  ","version":null,"tagName":"h2"},{"title":"Task 4â€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#task-4","content":" Now that we have identified the workstation, a triage including PowerShell logs and Prefetch files are provided to you for some deeper insights so we can understand how this activity occurred on the endpoint. What is the name of the file used to Enumerate Active directory objects and possibly find Kerberoastable accounts in the network?  First step is to take a look at the PowerShell logs, we should be able to analyze and discern which file is being written to or accessed in order to carry out the enumeration of AD objects.  Looking at the contents of the PowerShell log file we can see numerous events that are classified as warnings with the event code of 4104 which pertains to PowerShell script block logging. Each of the events of this type have one thing in common, they are all invoked by the file powerview.ps1.  Task Flag: powerview.ps1  ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#task-5","content":" When was this script executed?  The first instance of the powerview.ps1 script being executed happened at 5/20/2024 11:16:32 PM EST. We can discern this further and anticipate further executions via investigating the log details, which state at the top: Creating Scriptblock text (1 of 20):,. the event of which is followed by 19 more script block events.  Converting the time of the event to UTC and to the format requested for the flag we get: 2024-05-21 03:16:32.  Task Flag: 2024-05-21 03:16:32  ","version":null,"tagName":"h2"},{"title":"Task 6â€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#task-6","content":" What is the full path of the tool used to perform the actual kerberoasting attack?  Okay so we know that the enumeration and Kerberoasting attack came from the same machine. We should look through the prefetch files and look at suspicious file names or common names of tools used to carry out Kerberoasting attacks.  Looks like we didn't have to look far, we have a file inside of the \\2024-05-21T033012_triage_asset\\C\\Windows\\prefetch directory named Rubeus.exe.  We need to analyze the prefetch of this file for metadata that would allow us to determine when the file was first executed.  For this task I will make use of PECmd, which is a forensics tool created by Eric Zimmerman that allows for parsing of prefect files, displaying a wealth of metadata. I also read a guide on how to use the tool here. Thanks Matt B!  Using the guide and documentation I ran the tool using the -f flag specifying PECmd to scan the RUBEUS.EXE-5873E24B.pf file and got the following output.  PS C:\\Tools&gt; .\\PECmd.exe -f 'C:\\Sherlocks\\Campfire 1\\Triage\\Workstation\\2024-05-21T033012_triage_asset\\C\\Windows\\prefetch\\RUBEUS.EXE-5873E24B.pf' PECmd version 1.5.1.0 Author: Eric Zimmerman (saericzimmerman@gmail.com) https://github.com/EricZimmerman/PECmd Command line: -f C:\\Sherlocks\\Campfire 1\\Triage\\Workstation\\2024-05-21T033012_triage_asset\\C\\Windows\\prefetch\\RUBEUS.EXE-5873E24B.pf Keywords: temp, tmp Processing C:\\Sherlocks\\Campfire 1\\Triage\\Workstation\\2024-05-21T033012_triage_asset\\C\\Windows\\prefetch\\RUBEUS.EXE-5873E24B.pf Created on: 2024-05-21 05:02:37 Modified on: 2024-05-21 03:18:09 Last accessed on: 2025-04-03 18:06:34 Executable name: RUBEUS.EXE Hash: 5873E24B File size (bytes): 86,612 Version: Windows 10 or Windows 11 Run count: 1 Last run: 2024-05-21 03:18:08 Volume information: #0: Name: \\VOLUME{01d951602330db46-52233816} Serial: 52233816 Created: 2023-03-08 01:48:53 Directories: 56 File references: 178 Directories referenced: 56 00: \\VOLUME{01d951602330db46-52233816}\\USERS 01: \\VOLUME{01d951602330db46-52233816}\\USERS\\ALONZO.SPIRE 02: \\VOLUME{01d951602330db46-52233816}\\USERS\\ALONZO.SPIRE\\APPDATA 03: \\VOLUME{01d951602330db46-52233816}\\USERS\\ALONZO.SPIRE\\APPDATA\\LOCAL 04: \\VOLUME{01d951602330db46-52233816}\\USERS\\ALONZO.SPIRE\\APPDATA\\LOCAL\\MICROSOFT 05: \\VOLUME{01d951602330db46-52233816}\\USERS\\ALONZO.SPIRE\\APPDATA\\LOCAL\\MICROSOFT\\WINDOWS 06: \\VOLUME{01d951602330db46-52233816}\\USERS\\ALONZO.SPIRE\\APPDATA\\LOCAL\\MICROSOFT\\WINDOWS\\SCHCACHE --SNIP-- Files referenced: 109 00: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\NTDLL.DLL 01: \\VOLUME{01d951602330db46-52233816}\\USERS\\ALONZO.SPIRE\\DOWNLOADS\\RUBEUS.EXE (Executable: True) 02: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\MSCOREE.DLL 03: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\KERNEL32.DLL 04: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\KERNELBASE.DLL 05: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\LOCALE.NLS 06: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\APPHELP.DLL 07: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\APPPATCH\\SYSMAIN.SDB 08: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\ADVAPI32.DLL 09: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\MSVCRT.DLL 10: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\SECHOST.DLL 11: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\RPCRT4.DLL 12: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\SYSTEM32\\BCRYPT.DLL 13: \\VOLUME{01d951602330db46-52233816}\\WINDOWS\\MICROSOFT.NET\\FRAMEWORK64\\V4.0.30319\\MSCOREEI.DLL --SNIP--   We can see that the tool provides a list of directories and files that were referenced. In the list of files referenced we can see an entry for RUBEUS.EXE, with the full path to the malicious file being C:\\users\\alonzo.spire\\downloads\\rubeus.exe.  Task Flag: C:\\Users\\Alonzo.spire\\Downloads\\Rubeus.exe  ","version":null,"tagName":"h2"},{"title":"Task 7â€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#task-7","content":" When was the tool executed to dump credentials?  For the last and final task, the flag is in the output of the command used in the previous task. We run PECmd, on the target prefetch file, RUBEUS.EXE-5873E24B.pf and analyze the output.  The output displays a time value for the last time the executable was run, and lucky for us, the tool outputs the time in UTC.  Executable name: RUBEUS.EXE Hash: 5873E24B File size (bytes): 86,612 Version: Windows 10 or Windows 11 Run count: 1 Last run: 2024-05-21 03:18:08   Task Flag: 2024-05-21 03:18:08  ","version":null,"tagName":"h2"},{"title":"Investigation Completeâ€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#investigation-complete","content":"   ","version":null,"tagName":"h2"},{"title":"Key Takeawaysâ€‹","type":1,"pageTitle":"Campfire 1 (HTB-Sherlock)","url":"/blog/Campfire1-Sherlock#key-takeaways","content":" Windows Prefetch files are useful in forensics as they provide useful information like executable name, file path, number of executions, lists of DLLs and files accessed.PECmd is a useful tool for examining the metadata of prefetch files, allowing for investigation of these files straight from the command line. PECmd also has the ability to output to .csv and .json file types for further analysis with other tools. ","version":null,"tagName":"h2"},{"title":"CrownJewel 2 (HTB-Sherlock)","type":0,"sectionRef":"#","url":"/blog/CrownJewel2-Sherlock","content":"","keywords":"Hack The Box Sherlock CrownJewel DFIR NTDS","version":null},{"title":"Scenarioâ€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#scenario","content":" Forela's Domain environment is pure chaos. Just got another alert from the Domain controller of NTDS.dit database being exfiltrated. Just one day prior you responded to an alert on the same domain controller where an attacker dumped NTDS.dit via vssadmin utility. However, you managed to delete the dumped files kick the attacker out of the DC, and restore a clean snapshot. Now they again managed to access DC with a domain admin account with their persistent access in the environment. This time they are abusing ntdsutil to dump the database. Help Forela in these chaotic times!!  ","version":null,"tagName":"h2"},{"title":"The Filesâ€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#the-files","content":" In typical Sherlock fashion we have a single .zip file that contains some files for the investigation process. In the case of this investigation, extracting the archive we can see a folder called Artifacts that has a set of .evtx files. Each of the log files pertain to a different log provider, Application, Security, and System.    ","version":null,"tagName":"h2"},{"title":"Task 1â€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#task-1","content":" When utilizing ntdsutil.exe to dump NTDS on disk, it simultaneously employs the Microsoft Shadow Copy Service. What is the most recent timestamp at which this service entered the running state, signifying the possible initiation of the NTDS dumping process?  Service start/stop and other related conditions are logged by the SYSTEM log provider. We should take a look at the SYSTEM .evtx file to take a look. For the sake of enhancing learning and also getting more practice with Eric Zimmerman's Forensic Tools, I will be making use of EvtxECmd and Timeline Explorer for analysis.    In the above I processed the SYSTEM.evtx log file using the tool. This parses and formats the log file into a .csv file that can be viewed inside of Timeline Explorer, allowing for viewing and filtering of log data in ways the Windows Event Viewer cannot. I also did this for the rest of the log files present in the artifacts folder.    Opening the new system.csv file in Timeline Explorer, I filtered the Map Description column for the term started, pertaining to Service started or stopped. Then I filtered the Payload Data column for the word shadow. This was sufficient to bring up all events that pertained to the starting/stopping of the Volume Shadow Copy service.    Found 4 logs in total, the most recent of which being the starting of the Volume Shadow copy service on 05/15/2024 05:39:55. Take note that when EvtwECmd parses log files, it normalizes the time format to UTC.    Changing the time/date format to HTB flag requirements, the task flag would be, 2024-05-15 05:39:55.    ","version":null,"tagName":"h2"},{"title":"Task 2â€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#task-2","content":" Identify the full path of the dumped NTDS file.  This time, we will load up our parsed application logs in Timeline Explorer. The normal path for the NTFS ntds.dit database file is C:\\Windows\\NTDS\\, any deviation from this would indicate that malicious activity is going on related to the database file. Opening the file, I filtered the logs via the find function and took a look at the results.    In the image above we are focused on the payload data of each log event. Taking a look toward the bottom of the log results we can see entries that pertain to the directory C:\\Windows\\Temp\\dump_tmp\\Active Directory\\ntds.dit. The related event ID is 325 and is a log generated when a new database is created.  As it turns out, this directory is indeed the task flag.    ","version":null,"tagName":"h2"},{"title":"Task 3â€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#task-3","content":" When was the database dump created on the disk?  Going back to the same event log and checking the time, we can see that the database dump was created on 2024-05-15 05:39:56.      ","version":null,"tagName":"h2"},{"title":"Task 4â€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#task-4","content":" When was the newly dumped database considered complete and ready for use?  Reviewing the parsed application logs in Timeline Explorer, we can see an event a few seconds after where the ntds database was detached, this signifies that the dump of the database was completed and thus, the time of this event should be the task flag.    The task flag in this case being: 2024-05-15 05:39:58    ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#task-5","content":" Event logs use event sources to track events coming from different sources. Which event source provides database status data like creation and detachment?  In Windows when logs are generated they come from different providers. Providers are tasked with logging information specific to a type of action, application, OS function, etc. They allow for tracking just like the task describes. Finding the provider generated logs is a simple task and is made even simpler via the parsing done by EvtwECmd. In Timeline Explorer all we need to do is adjust the filtering and the columns to clearly see that the provider for creation and detachment of databases comes from the ESENT provider.      ","version":null,"tagName":"h2"},{"title":"Task 6â€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#task-6","content":" When ntdsutil.exe is used to dump the database, it enumerates certain user groups to validate the privileges of the account being used. Which two groups are enumerated by the ntdsutil.exe process? Give the groups in alphabetical order joined by comma space.  Did some research into what event IDs pertain to the enumeration of groups on a given environment. I found that event ID 4799 logs when a security-enabled local group is enumerated. 1 These events are logged to the security section event logs so let's start there in our search.    Looking at the parse security log, check the image above, I filtered for the event ID 4799 and I also observed that there are 3 payload columns, of which Payload Data 1 contains the target group for enumeration and Payload Data 3 contains the process carrying out the enumeration. I filtered for ntds in column 3 as well. With the filters applied you can see that around the same time that the ntds database was dumped, we have multiple enumerations for the Administrators and Backup Operators groups.    ","version":null,"tagName":"h2"},{"title":"Task 7â€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#task-7","content":" Now you are tasked to find the Login Time for the malicious Session. Using the Logon ID, find the Time when the user logon session started.  At the start of this Sherlock investigation we are given the key detail that we are inside of an Active Directory environment. In most cases we should be looking for Kerberos authentication of some kind when a user logs into a machine or the domain controller. In AD environments Kerberos is used primarily when the client and the target server/services are all on the same domain/domain-joined. 2  With that in mind, what event IDs pertain to Kerberos authentication? Well if you haven't read my blog post on Kerberoasting you should check it out. It has details related to how the Kerberos authentication process is carried out, and how threat actors exploit the process. For the sake of time and to focus on obtaining the task flag I will list the event ID's what we need here.  4768 - A Kerberos Authentication Ticket (TGT) was requested. 34769 - A Kerberos service ticket was requested. 4    In Timeline Explorer we have the ability to group events via column values, in the image above I grouped all the events by event ID. We can see that we have a count of 3 events for event ID 4768 and 7 for event ID 4769.  Digging deeper into the log details I hid all of the unneeded columns, focusing the time of event, description, and payload data of the filtered event logs. We can see that a Kerberos ticket granting ticket, was requested and granted for the Forela/Administrator account. This was followed up with a service ticket request at the exact same time, meaning that the time of malicious session was 2024-05-15 05:36:31.    ","version":null,"tagName":"h2"},{"title":"ðŸ”‘ Key Takeawaysâ€‹","type":1,"pageTitle":"CrownJewel 2 (HTB-Sherlock)","url":"/blog/CrownJewel2-Sherlock#-key-takeaways","content":" ðŸ§­ Parsing .evtx logs with EvtxECmd and loading them into Timeline Explorer gave us the flexibility to filter, search, and correlate events in a way that the standard Event Viewer just doesnâ€™t allow. This workflow continues to prove itself useful across these Sherlock labs.ðŸ•µï¸â€â™‚ï¸ Attackers leveraged the Volume Shadow Copy Service as part of the NTDS dump. Tracking when this service starts can clue us in to the initial stages of database exfiltration activity.ðŸ“‚ Any time you see the ntds.dit file show up outside of its default location at C:\\Windows\\NTDS\\, alarms should go off. In this case, it showed up in a temp directory, which is a strong indicator of suspicious behavior.ðŸ§¾ Logs from the ESENT provider helped us understand the lifecycle of the NTDS databaseâ€”creation, detachment, and overall status. If the database gets detached, odds are someone finished dumping it.ðŸ” Group enumeration showed up under Event ID 4799, and we were able to confirm that ntdsutil.exe queried both the Administrators and Backup Operators groups. This step is part of validating that the attacker has the necessary privileges to pull off the dump.â±ï¸ Pulling authentication details using Event IDs 4768 and 4769 helped us determine the exact login time for the attackerâ€™s session. Kerberos logs are a solid place to start when tracing malicious logons in Active Directory environments.  All in all, this lab reinforced the importance of knowing where to look, how to correlate logs across multiple providers, and how to piece together the timeline of an attack from what the system leaves behind.    Footnotesâ€‹ https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4799 â†© https://www.hackthebox.com/blog/what-is-kerberos-authentication#:~:text=Kerberos%20is%20the%20default%20protocol,authenticate%20them%20via%20mutual%20authentication. â†© https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4768 â†© https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4769 â†© ","version":null,"tagName":"h2"},{"title":"Mastering Identity & Access Management","type":0,"sectionRef":"#","url":"/blog/Mastering Identity & Access Management","content":"","keywords":"IAM identity access management Entra ID cybersecurity","version":null},{"title":"The Pillars of IAMâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#the-pillars-of-iam","content":" Here are the core concepts that make up IAM:  ","version":null,"tagName":"h2"},{"title":"Identity Managementâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#identity-management","content":" Identity Management involves the creation, maintenance, and deletion of accounts. Each user is assigned a unique identity that is placed into a repository. Users can manage their own profiles and reset passwords.  Example: Consider an organization that onboards new employees into its Active Directory/Entra ID system. The user receives account information to access their laptop, email, and other enterprise apps. AD/Entra ID administrators can update the account and make changes if the user changes roles or needs new permissions. The user can update their password and some profile information, like their profile photo. Once the user leaves, the account is marked for deletion based on the organization's account handling policies. On the day of off-boarding, the user will no longer have access to their account or any company resources.  ","version":null,"tagName":"h3"},{"title":"Authenticationâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#authentication","content":" Authentication verifies the identity of users, devices, or systems, ensuring that the party requesting access is who they claim to be.  Example: The Contoso Organization has configured its Active Directory/Entra ID systems with MFA, SSO, and Biometrics. When a user attempts to authenticate, they need a second factor of authentication. Users onboard with a fingerprint reader to generate biometric data. This data, along with the username and password, verifies the user's identity. SSO allows the user to stay logged in and not be prompted to authenticate when accessing enterprise applications. Admins can adjust the interval or factors required for re-authentication.  ","version":null,"tagName":"h3"},{"title":"Authorizationâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#authorization","content":" Authorization determines what an authenticated user is allowed to do. This is achieved by setting up and enforcing policies. Entra ID uses Role-Based Access Control (RBAC), Attribute-Based Access Control (ABAC), and Policy-Based Access Control mechanisms for comprehensive user authorization.  Example: Contoso sets up RBAC so that only Operations department users have access to their cloud-based inventory management system. Warehouse users do not see this web app on their Entra ID My Apps page.  Contoso uses Entra ID Conditional Access to control login times, enforcing work hours and enhancing information security. These policies, based on attributes such as time and location, implement Attribute-Based Access Control.  Contoso also implements a Conditional Access policy that restricts access to the sales ERP system, which contains SPII, to on-premise users only.  ","version":null,"tagName":"h3"},{"title":"Access Managementâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#access-management","content":" Access Management enforces the policies and controls implemented, ensuring users have proper access to appropriate resources. Users should also be able to request specific access when needed.  Example: Contoso has enabled Privileged Identity Management (PIM) on their Entra ID tenant. PIM allows admins to configure eligible roles for specific groups or roles and control the duration and scope of these roles. Users with eligible roles can request access, pending admin approval.  ","version":null,"tagName":"h3"},{"title":"Governance and Complianceâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#governance-and-compliance","content":" Governance and Compliance involve adhering to regulatory requirements, internal policies, and industry standards. Auditing, reporting, policy management, and risk management fall under this pillar.  Example: Contoso configured Active Directory/Entra ID to make logs available for further investigation in Entra ID. Admins can view these logs in Microsoft Sentinel or ingest them into a SIEM or SOAR platform. These platforms report on user, group, and application activity, providing threat scoring and enabling security analysts to manage risk. Entra ID also includes Identity Protection and Risk-Based Conditional Access policies for managing user and sign-in risk.  ","version":null,"tagName":"h3"},{"title":"Monitoring and Intelligenceâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#monitoring-and-intelligence","content":" Monitoring and Intelligence involve continuously analyzing user activities to detect and respond to anomalies and security threats.  Example::As mentioned earlier, Contoso logs are ingested into a SIEM or SOAR platform, where security analysts monitor user, group, and app activities. Microsoft Entra ID Identity Protection assists in detecting, investigating, and remediating risks. Admins can investigate user behavior, mark identities as compromised, and start remediation processes, such as password resets and MFA registration.  ","version":null,"tagName":"h3"},{"title":"Lifecycle Managementâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#lifecycle-management","content":" Lifecycle Management covers the entire identity lifecycle, from initial provisioning to de-provisioning and account cleanup. It also includes handling lifecycle events, such as promotions or department transfers, requiring changes in access levels, and ensuring account status matches the user's current status in the organization.  Example: Contoso hires George as a Quality Assurance manager. HR requests a Windows account with appropriate permissions from IT. Entra ID admins create the account with a role matching George's title. Upon George's promotion, admins update his role, granting access to more enterprise apps, including those with SPII. When George decides to leave after two years, HR informs IT of his departure date. Admins set Entra ID to disable the account on George's last workday. His identity is placed in the &quot;Deleted Users&quot; section, allowing 30 days for possible restoration.  ","version":null,"tagName":"h3"},{"title":"Key Takeawaysâ€‹","type":1,"pageTitle":"Mastering Identity & Access Management","url":"/blog/Mastering Identity & Access Management#key-takeaways","content":" In summary, Identity and Access Management (IAM) is crucial for securing organizational resources and implementing least privilege access. By leveraging Entra ID, organizations can effectively manage identity lifecycle, authenticate users, enforce access policies, and ensure compliance. Understanding the pillars of IAMâ€”Identity Management, Authentication, Authorization, Access Management, Governance and Compliance, Monitoring and Intelligence, and Lifecycle Managementâ€”enables businesses to build a robust security framework. Implementing these practices helps protect sensitive information, streamline user access, and enhance overall security posture. ","version":null,"tagName":"h2"},{"title":"CrownJewel 1 (HTB-Sherlock)","type":0,"sectionRef":"#","url":"/blog/CrownJewel1-Sherlock","content":"","keywords":"Hack The Box Sherlock CrownJewel NTDS Windows forensics","version":null},{"title":"Scenarioâ€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#scenario","content":" Forela's domain controller is under attack. The Domain Administrator account is believed to be compromised, and it is suspected that the threat actor dumped the NTDS.dit database on the DC. We just received an alert of vssadmin being used on the DC, since this is not part of the routine schedule we have good reason to believe that the attacker abused this LOLBIN utility to get the Domain environment's crown jewel. Perform some analysis on provided artifacts for a quick triage and if possible kick the attacker as early as possible.  Okay so we have some key details from this scenario description of the incident. The domain admin account has been compromised and it is suspected that the threat actor dumped the NTDS.dit database.  I went ahead and looked up some details about NTDS.dit, and found TTP information related to the actions taken in this scenario on the MITRE ATT&amp;CK website: OS Credential Dumping: NTDS.  Attack Details:  NTDS File location on domain controller: %SystemRoot&amp;\\NTDS\\Ntds.ditNTDS File allows for exporting of AD data base, this allows credential access.Built in Windows tool , ntdsutil.exe can be used to access database contained in Ntds.dit file, as well as PowerShell commands and Python tools.  Detection:  Command Execution on DC: Look for event IDs 4688 &amp; 1(Sysmon). Investigate commands targeting NTDS.dit file and path.File Access: Events 4656 and 4663 (Microsoft Windows Security Auditing). Look for users requesting access to NTDS file or accessing file objects related to NTDS.dit.  Now we are armed with key information about indicators of this type of attack. Let's move on to the provided files.  ","version":null,"tagName":"h2"},{"title":"The Filesâ€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#the-files","content":" Extracting the provided zip file, we have 3 .etwv log files, all of which pertain to a different log provider, coming from the affected DC.    We also have what looks to be prefetch files taken at the time of attack. This includes the $MFT file, which includes all the file permissions and actions that have taken place on the system since Windows install.    We will probably be using Eric Zimmerman's tool suite, which includes tools like MFTCmd and Timeline Explorer to investigate changes to files on the system at the time of the incident.  ","version":null,"tagName":"h2"},{"title":"Task 1â€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#task-1","content":" Attackers can abuse the vssadmin utility to create volume shadow snapshots and then extract sensitive files like NTDS.dit to bypass security mechanisms. Identify the time when the Volume Shadow Copy service entered a running state.  ","version":null,"tagName":"h2"},{"title":"Volume Shadow Serviceâ€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#volume-shadow-service","content":" VSS or volume shadow service is a backup mechanism present in later versions of the Windows OS, it allows for automatic incremental backup of all files on a given disk or partition. It's common for organizations to enable the service as a way to mitigate the effects of Malware and Ransomware, providing a snapshot to restore a system to, in the event that an incident of this type takes place.  Threat actors have taken note of this behavior, so it is common for threat actors to target and attempt to delete volume shadow copies and disable the service entirely.1  Doing some research as to the event IDs associated with the starting of services and also the starting of the VSS service specifically, I found the following:  7036 - Service has entered a state (Starting, Stopping, Paused, Resumed)8224 - VSS Service shutdown due to timeout.8225 - VSS Service shutdown due to Service Control Manager event.  ","version":null,"tagName":"h3"},{"title":"Log Analysisâ€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#log-analysis","content":" First, I will open the SYSTEM.evtx file as service changes (Event 7036) are logged there. Looking at the logs we can see a lot of events pertaining to the changing of service statuses.    Scrolling through the logs, I found an entry for the VSS starting at 11:42 PM on May 13th 2024. Take note that this timestamp is in my local time so for the flag and most HTB flags, the time and date need to be converted to UTC.    Converting the time and date to UTC I got the task flag, which is 2024-05-14 03:42:16.    ","version":null,"tagName":"h3"},{"title":"Task 2â€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#task-2","content":" When a volume shadow snapshot is created, the Volume shadow copy service validates the privileges using the Machine account and enumerates User groups. Find the two user groups the volume shadow copy process queries and the machine account that did it.  Let's focus our attention to what events would be generated in this event. The shadow copy service should generate some sort of event for the action of a snapshot being created. After completing some research I found the following events to be of interest:  8226 - VSS successful creation of snapshot.12289 - Detailed information about stages of the snapshot process.12292 - Detailed Information about writer components used during snapshot creation.  I looked through the SYSTEM event logs but, did not find anything related to these event IDs. Looking at the SECURITY event logs provided did produce some insight. Around the same time that the Volume Shadow Copy service was started there are events pertaining to Event ID 4799, which logs enumeration of members of a security-enabled group. Also, the log details state that the originating process is VSSVC.exe, which is the Volume Shadow Copy service.    There are eight logs in total that are related to enumeration, coming from the Volume Shadow Copy process. They all make use of the account name DC01$ and the user groups that were targeted were, Administrators, and Backup Operators.    Putting these groups in the order in which they were used and in the flags requested format, we get Administrators, Backup Operators, DC01$, which is confirmed to be the task flag.    ","version":null,"tagName":"h2"},{"title":"Task 3â€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#task-3","content":" Identify the Process ID (in Decimal) of the volume shadow copy service process.  This information can be gathered from the same set of logs from Task 2. In the log details the process ID of the Volume Shadow Copy service is 0x1190.    The value is in Hexadecimal, so we have to convert it. Converting it to decimal we get a value of 4496, which is the task flag.    ","version":null,"tagName":"h2"},{"title":"Task 4â€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#task-4","content":" Find the assigned Volume ID/GUID value to the Shadow copy snapshot when it was mounted.  For this task we should focus our attention on the NTFS log file provided. Events related to the mounting and unmounting of volumes should be logged there and provide the needed insight to obtain the task flag. Again the start of the Volume Shadow Copy process happened at 5/13/2024 11:42:16 PM EST or 5/14/2024 03:42:16 AM UTC, so we should look for mount events after this time.  Looking through the logs we can see and event 4 at 5/13/2023 11:44:22 PM EST, which signifies a volume mount operation. This took place a few minutes after the start of the shadow copy service.  The log details provide a Volume correlation ID, which is used by the service to track the creation of snapshots. This is also the value that we are looking for.    The Volume correlation ID being: {06c4a997-cca8-11ed-a90f-000c295644f9}.    ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#task-5","content":" Identify the full path of the dumped NTDS database on disk.  In the very start of this lab, I detailed out the list of files that we where given as a part of the investigation. Inside of the Artifacts folder and further once more into the C folder, we can see that we have an $MFT file. This is the master file record, which is a database present on NTFS systems. It contains file attributes such as time of creation, time of last edit, etc, and is an invaluable artifact to have when investigating security incidents which would have involved some sort of file manipulation.  In order to read the MFT file and view the attributes, I will be making use of a popular tool created by Eric Zimmerman, called MFT Explorer. The tool has a well laid out interface so that we can navigate through all the file data/attributes stored. Below I have loaded the MFT file into the tool.    In the above you can see that we have a similar file/folder structure to a normal windows explorer view but, we also have a hex view and a details pane. Where do we go from here? Where would the ntds.dit file be stored? Well, we have a few clues from the previous tasks. We know that the Administrators group was enumerated when VSS made a shadow copy. Looking at the users folder, the only user account of note is Administrator. Digging into the Administrator accounts user folder, I checked the desktop, downloads, and documents folder. The documents folder has an folder in it that had an interesting name, backup_sync_dc.    Also, in the above image you can note that the time lines up with the timeline of events that we have observed so far. Timeline Explorer shows all times and dates in UTC. The time of folder creation was 05-14-2024 03:38:46, which was a few minutes after the Volume Shadow Copy service was started.  Navigating into the folder, we can see an ntds.dit file. These files normally do not reside inside of user folders so, this file being here is abnormal. Also, just like the folder, the creation time is in line with the events that have been observed.    The full path to the database/file being C:\\Users\\Administrator\\Documents\\backup_sync_dc\\ntds.dit.    ","version":null,"tagName":"h2"},{"title":"Task 6â€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#task-6","content":" When was newly dumped ntds.dit created on disk?  Taking another look at the image below note the creation time of the file. The time and date are already in UTC time, so no need to convert it.    Hack the box asks for the flag to be in YYYY-MM-DD HH:MM:SS format, so the complete flag is: 2024-05-14 03:44:22.    ","version":null,"tagName":"h2"},{"title":"Task 7â€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#task-7","content":" A registry hive was also dumped alongside the NTDS database. Which registry hive was dumped and what is its file size in bytes?  In the same folder as the ntds.dit file there is also a file with no file extension, called SYSTEM. Inside of the MFTExplorer application there are no details about the size of this file. I opted to convert the MFT file into .csv format, using MFTCmd, also another of Eric Zimmerman's tools. I learned about Eric's suite of forensic tools while completing the module Intro to Digital Forensics as a part of my learning for the HTB-CDSA.    After conversion I opened up the file with Time Line Explorer and filtered for the folder path that both files resided in.    From the image above you can see that the SYSTEM file is found in the directory, also we can see that the file size information is present in bytes. The complete flag being SYSTEM, 17563648.    ","version":null,"tagName":"h2"},{"title":"ðŸ” Key Takeawaysâ€‹","type":1,"pageTitle":"CrownJewel 1 (HTB-Sherlock)","url":"/blog/CrownJewel1-Sherlock#-key-takeaways","content":" ðŸ§° Leveraging Eric Zimmerman's Tools for Deep Analysis Utilizing tools like EvtxECmd and MFTECmd allowed for efficient parsing of .evtx logs and the $MFT file. Coupled with Timeline Explorer, this setup provided a streamlined approach to sifting through vast amounts of data. ðŸ•µï¸ Identifying Service Start Events Filtering the SYSTEM.evtx log for Event ID 7036 was instrumental in pinpointing when the Volume Shadow Copy Service entered the running stateâ€”a critical indicator of potential malicious activity. ðŸ“ Uncovering Suspicious File Paths Analysis of the $MFT revealed the creation of ntds.dit in an unusual directory: C:\\Users\\Administrator\\Documents\\backup_sync_Dc\\. Such deviations from standard file locations can be indicative of unauthorized actions. ðŸ•’ Correlating Timestamps for Event Sequencing By examining the creation times of key files, a timeline of the attack was established, providing clarity on the sequence of malicious events. ðŸ§¾ Detecting Registry Hive Exfiltration The presence of the SYSTEM registry hive alongside the dumped ntds.dit file highlighted the attacker's intent to extract comprehensive system information, emphasizing the need to monitor for such activities. ðŸ” Understanding the Role of Built-in Utilities in Attacks The misuse of legitimate Windows utilities, like vssadmin, underscores the importance of monitoring and controlling the use of such tools within an environment.    Footnotesâ€‹ https://blogs.vmware.com/security/2022/09/threat-report-illuminating-volume-shadow-deletion.htmlIn this case the threat actors are taking advantage of the service to gain access to sensitive files. They have enabled the VSS service, so it is wise to look for events the pertain to the starting of the VSS service. â†© ","version":null,"tagName":"h2"},{"title":"Campfire 2 (HTB-Sherlock)","type":0,"sectionRef":"#","url":"/blog/Campfire2-Sherlock","content":"","keywords":"Hack The Box Sherlock Campfire AS-REP roasting Kerberos","version":null},{"title":"The Scenarioâ€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#the-scenario","content":" Forela's Network is constantly under attack. The security system raised an alert about an old admin account requesting a ticket from KDC on a domain controller. Inventory shows that this user account is not used as of now so you are tasked to take a look at this. This may be an AsREP roasting attack as anyone can request any user's ticket which has preauthentication disabled.  ","version":null,"tagName":"h2"},{"title":"The Filesâ€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#the-files","content":" For this Sherlock scenario, we are given a single .etwx log file to analyze. We will be looking for AsREP roasting from the looks of things so we should be on the lookout for indicators of such.  ","version":null,"tagName":"h2"},{"title":"Task 1â€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#task-1","content":" When did the ASREP Roasting attack occur, and when did the attacker request the Kerberos ticket for the vulnerable user?  Okay, let's open up that log file that we were given and take a look at the logs. For AsREP roasting, we should be on the hunt for malicious entries of event code 4768, which correlate to Kerberos Authentication TGT requests.  I went ahead and filtered the logs down to just event 4768 entries.  Looking through the now filtered results, see a suspicious request from a computer that we know is compromised. The user, Arthur.Kyle, had their computer compromised and used for a Kerberoasting attack. We know this from the previous investigation Campfire 1. We also know that the IP address of the computer was 172.17.79.129, from answering Task 3 of said investigation. Looks like Kerberos pre-authentication was not enabled for this user.  The time of the AsREP roasting was 5/29/2004 @ 2:36:40 AM EST. Converting that into UTC time and the format requested we get the task flag.  Task Flag: 2024-05-29 06:36:40  ","version":null,"tagName":"h2"},{"title":"Task 2â€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#task-2","content":" Please confirm the User Account that was targeted by the attacker.  In the previous task, we already stated that the user that was targeted for the attack was arthur.kyle, which you can see from the log of the initial AsREP attack.  Task Flag: arthur.kyle  ","version":null,"tagName":"h2"},{"title":"Task 3â€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#task-3","content":" What was the SID of the account?  Again, in the same event for the initial AsREP roasting attack. We have the SID of the targeted user account arthur.kyle, which is S-1-5-21-3239415629-1862073780-2394361899-1601  Task Flag: S-1-5-21-3239415629-1862073780-2394361899-1601  ","version":null,"tagName":"h2"},{"title":"Task 4â€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#task-4","content":" It is crucial to identify the compromised user account and the workstation responsible for this attack. Please list the internal IP address of the compromised asset to assist our threat-hunting team.  Yet again in the same event log, we can scroll down to the network details of the computer that made the request to the KDC. We can see that both the IPv6 &amp; IPv4 addresses of the machine are present, as well as the port used. The IP address 172.17.79.129.  Task Flag: 172.17.79.129  ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#task-5","content":" We do not have any artifacts from the source machine yet. Using the same DC Security logs, can you confirm the user account used to perform the ASREP Roasting attack so we can contain the compromised account/s?  Okay so looking through the log file in event viewer. I see two events that correlate with each other and give a picture of how the threat actor gained access to another account.  In the image below we can see that the user arthur.klye, and their computer, which we know are compromised, requested a Kerberos authentication ticket. Note the IP address  The very next event logged is for Kerberos Service Ticket Operations, which allows for requesting service tickets for access to services on a given domain. This operation requires that a TGT be already issued for the requesting account. From the log information we can see that the username has changed. This potentially means that the threat actor used arthur.kyle's computer to request a TGT for another account that had more access. Also note that the event came from the same IP of arthur.kyle's machine.  To further backup our hypothesis, after the service ticket was requested and granted for the user account happy.grunwald, there are two 5140 events logging that account accessing two shares, \\\\*\\IPC$ &amp; \\\\*\\DC-Confidential. The threat actor appears to be searching for sensitive data to exfiltrate.  Task Flag: happy.grunwald  ","version":null,"tagName":"h2"},{"title":"Investigation Completeâ€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#investigation-complete","content":"   ","version":null,"tagName":"h2"},{"title":"Key Takeawaysâ€‹","type":1,"pageTitle":"Campfire 2 (HTB-Sherlock)","url":"/blog/Campfire2-Sherlock#key-takeaways","content":" AsREP roasting allows for threat actors to request service tickets for accounts that do not have Kerberos pre-authentication enabled. This allows threat actors to gain access to any services/resources provisioned for the target user. ","version":null,"tagName":"h2"},{"title":"What I've Learned - Network Traffic Analysis","type":0,"sectionRef":"#","url":"/blog/NetTrafficAnalysis","content":"","keywords":"network traffic analysis Wireshark tcpdump detection cybersecurity","version":null},{"title":"Why is Network Traffic Analysis Important?â€‹","type":1,"pageTitle":"What I've Learned - Network Traffic Analysis","url":"/blog/NetTrafficAnalysis#why-is-network-traffic-analysis-important","content":" This is a good question to pose as we need to establish the intent and need for Network Traffic Analysis.  Network Traffic Analysis, can be defined as inspecting of network traffic patterns, analysis network protocol behavior, and analyzing network packets for abnormal behavior, or indicators of compromise.  When you think about it networks are the core of IT infrastructure. Without a network, computers and servers providing services can not communicate with one another. This need for communication is the very reason computers are interconnected in the first place. Threat actors know that communication is paramount to organizations and individuals and by association, the work that they do. Threat actors use this fact and exploit a given network for various reasons.  To disrupt service and functionalityTo capture and exfiltrate data.To gain unauthorized access to a network or service.  Regular checking and investigation of network traffic is important as many times abnormal network communication is the first indicator that something malicious has or will take place.  Citing the NIST publication Network Security Traffic Analysis Platform - Design and Validation, it states:  Real-time traffic management and control have become necessary in today's networks due to their complexity and cybersecurity risks. With the increase in internet use, threats are more present and require real-time detection and analysis to prevent intrusions. As the number of data flows increases, the number and the types of attacks increase, which makes detecting intrusions challenging. Over the last years, many researchers have focused on different ways to detect intrusions in different systems. In this work, we describe the design and evaluation of a network security traffic analysis platform (NSTAP) to collect, view, search and analyze traffic data in real-time. Through charts, tables, histograms and other visualization methods, we demonstrate its power and usefulness with results obtained with simple time analytics of large data volumes. This work is intended to be the foundation for machine learning based automation tools.  ","version":null,"tagName":"h2"},{"title":"What is the Process?â€‹","type":1,"pageTitle":"What I've Learned - Network Traffic Analysis","url":"/blog/NetTrafficAnalysis#what-is-the-process","content":" The process of analyzing network traffic is cyclical. The higher level process steps inform the bottom level steps and vise versa, information is echoed to each other until the full picture of the threat actors actions come into view.  ","version":null,"tagName":"h2"},{"title":"Steps of the Cycleâ€‹","type":1,"pageTitle":"What I've Learned - Network Traffic Analysis","url":"/blog/NetTrafficAnalysis#steps-of-the-cycle","content":" Monitoring - The continuous capture of data from the network using tools like Tcpdump, Wireshark, or a SIEM platform.Analysis - Reviewing of data captured. Looking for anomalies, patterns, and threats.Action - Implementing changes in an effort to remediate the issue and harden the given network, servers/services, and hosts from future attack.Documentation and Review - Logtargetteds and Reports of given incidents are used to assess the current processes around responding to the incident. Things like what tools where used to investigate and also remediate the issue. Could this be streamlined further?Adaptation and Improvement - Lessons learned from the entire cycle, used to create refinements and efficiencies in analyzing and responding to found incidents or events. Drives improvement through out the entire cycle.  ","version":null,"tagName":"h3"},{"title":"Tools Usedâ€‹","type":1,"pageTitle":"What I've Learned - Network Traffic Analysis","url":"/blog/NetTrafficAnalysis#tools-used","content":" The most commonly used tools for Network Traffic Analysis are as follows:  Wireshark - GUI based network packet capture and analysis tool. Has a host of features that allow for granular filtering of captured traffic, plugins that include functions for displaying statistics about packets captured, rebuilding of protocol traffic flows, and exporting of transferred data, files, images, etc. Makes use of BPF syntax for filtering.TShark - Terminal based version of Wireshark that has many of the same features. Is accessed via the CLI and does not have a GUI. Also uses BPF Syntax for filtering.Tcpdump - Terminal based packet sniffer/capture and analysis tool for Unix based systems. Has a host of features that are accessed via flags that are used to define whether to read or write a packet capture file, and how to filter the file and display the output.  ","version":null,"tagName":"h2"},{"title":"BPF Syntaxâ€‹","type":1,"pageTitle":"What I've Learned - Network Traffic Analysis","url":"/blog/NetTrafficAnalysis#bpf-syntax","content":" Stands for Berkeley Packet Filter Syntax and was created by two individuals, Steven McCanne and Van Jacobson, while they were at Berkeley College's Lawrence Laboratory. 1 The syntax is widely used in packet capture and filtering tools due to it's ability to quickly reduce packet captures to targeted results. 2  ","version":null,"tagName":"h3"},{"title":"Detection and Threat Huntingâ€‹","type":1,"pageTitle":"What I've Learned - Network Traffic Analysis","url":"/blog/NetTrafficAnalysis#detection-and-threat-hunting","content":" Network Traffic Analysis and be used for detection of malicious activity on a given network but, in the case that their is no SIEM or IDS/IPS system running on the network. Network Traffic Analysis can be used to hunt for threats. Through the use of packet analysis, looking for odd connections to or from hosts, looking at large amounts of data being transferred over a network during non-work hours could be indicators of malicious activity.  ","version":null,"tagName":"h2"},{"title":"Wireshark File Extractionâ€‹","type":1,"pageTitle":"What I've Learned - Network Traffic Analysis","url":"/blog/NetTrafficAnalysis#wireshark-file-extraction","content":" Wireshark has the ability to follow traffic flows and rebuild data that has been transferred to completion, over a given network. This specific functionality is called the dissector, which will reassemble the data into the original file. This allows for complete files to be analyzed or read in isolated environments, providing more insight as to what is actually taking place.3    Footnotesâ€‹ https://en.wikipedia.org/wiki/Berkeley_Packet_Filter â†© https://www.ibm.com/docs/en/qsip/7.4?topic=queries-berkeley-packet-filters â†© https://www.wireshark.org/docs/wsug_html_chunked/ChIOExportSection.html â†© ","version":null,"tagName":"h2"},{"title":"Site Up and Running","type":0,"sectionRef":"#","url":"/blog/Site Up and Running","content":"Hello all, ðŸ‘‹ðŸ½ My name is Dario and I've been working in the IT Support space for 5 years total. 4 years working for Amazon and 1 year working for The Chefs Warehouse. Over the course of my experience I have had some amazing hands on time with some great technologies. Checkout the projects section for more info on projects that I have worked on. Inception of the Site This site came about because I needed a place on the internet to share my work and my musings about technology, AI, and software development.","keywords":"Dario Cruz blog launch personal website portfolio Docusaurus","version":null},{"title":"Security+ Passed!","type":0,"sectionRef":"#","url":"/blog/Security-Plus-Passed","content":"","keywords":"Security+ CompTIA certification cybersecurity study","version":null},{"title":"The Exam Experienceâ€‹","type":1,"pageTitle":"Security+ Passed!","url":"/blog/Security-Plus-Passed#the-exam-experience","content":" Out of all the exams I have taken so far, I feel that the difficulty level of this exam was moderate. It would be harder if you took the exam without any prior IT experience. My exam comprised 3 performance-based questions, in which I had to use my knowledge to complete a set of tasks, and 72 multiple-choice questionsâ€”75 questions in total. As long as you have a study guide or a video course that covers all the exam domains, you should be fine. I took the time to dig deeper into specific topics, most notably Cryptography and Public Key Infrastructure, as those topics alone contain a wide range of technologies and concepts.  Additionally, it's pretty important to have a good set of practice exams. For this exam, I didnâ€™t use Anki flashcards. My thinking was that, since I had already learned most of the content through the Google Cybersecurity Professional course, I wouldnâ€™t need additional reinforcement as the concepts were already set in my memory. This approach worked well; any reinforcement of knowledge came from the practice exams, which gave me the needed feel of taking the actual test. My mind was ready! ðŸ¤“  ","version":null,"tagName":"h2"},{"title":"Resourcesâ€‹","type":1,"pageTitle":"Security+ Passed!","url":"/blog/Security-Plus-Passed#resources","content":" Here is a list of all of the resources that I used to study for the exam:  SY0-701 Study Guide by Joe Shelly &amp; Darril GibsonJosh Madakor Security+ Practice Questions - LognPacificWhizLabs Security+ SY0-701 Practice Exams ","version":null,"tagName":"h2"},{"title":"Noxious (HTB-Sherlocks)","type":0,"sectionRef":"#","url":"/blog/Noxious-HTB-Sherlocks","content":"","keywords":"Hack The Box Sherlock Noxious LLMNR NTLM","version":null},{"title":"Scenarioâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#scenario","content":" The IDS device alerted us to a possible rogue device in the internal Active Directory network. The Intrusion Detection System also indicated signs of LLMNR traffic, which is unusual. It is suspected that an LLMNR poisoning attack occurred. The LLMNR traffic was directed towards Forela-WKstn002, which has the IP address 172.17.79.136. A limited packet capture from the surrounding time is provided to you, our Network Forensics expert. Since this occurred in the Active Directory VLAN, it is suggested that we perform network threat hunting with the Active Directory attack vector in mind, specifically focusing on LLMNR poisoning.  ","version":null,"tagName":"h2"},{"title":"The Filesâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#the-files","content":" Okay so in the zip file for the Sherlock we have a single .pcap file which means we will be flexing our Wireshark/TCPdump skills in this investigation.  ","version":null,"tagName":"h2"},{"title":"Task 1â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-1","content":" Its suspected by the security team that there was a rogue device in Forela's internal network running responder tool to perform an LLMNR Poisoning attack. Please find the malicious IP Address of the machine.  Hmmmm, okay so the acronym LLMNR is new to me, so it's time to educate myself on that it means, and also how it can be used by a threat actor that has access to an organizations network.  ","version":null,"tagName":"h2"},{"title":"Link-Local Multicast Name Resolutionâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#link-local-multicast-name-resolution","content":" So, it's a network protocol, and it's based on the DNS packet format. It allows both IPv4 and IPv6 hosts and devices to perform name resolution on the same network link. 1  ","version":null,"tagName":"h3"},{"title":"How LLMNR worksâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#how-llmnr-works","content":" Okay so digging deeper into how the protocol works, so that we know what the normal baseline behavior should be, looking at this image 2 it looks like LLMNR works similar to DNS, meaning that a central server is responsible for requests, this means that any deviation in where requests are sent and responded to, should provide us with information on the machine that is on the network carrying out the attack.  LLMNR Poisoning Attacksâ€‹  How can LLMNR be poisoned? How can it be used to attack a system? According to this article from MITRE, adversaries will spoof and present themselves as an authoritative source for name resolution, allowing for the threat actor to collect and/or relay authentication data. Yikes! Threat actors will respond to LLMNR requests as though they know the identity of the requested host, poisoning the service and getting the victims to communicate with the threat actor controlled system.  The goal of the attack is to collect hashes used in authentication which could be used for cracking of the hashes via offline brute forcing, leading to the obtaining of account passwords. 3  Detectionâ€‹  Lucky for us, on the same page of this article MITRE provides information on how to detect the incident. More specifically, since we only have access to the pcap of the security incident and not the Windows logs of the machines affected, we can narrow our focus to the Network Traffic data source.  Monitor network traffic on UDP Ports 5355 and UDP 137, if LNMR is disabled via security policy.Monitor network traffic originating from unknown/unexpected hardware devices.  ","version":null,"tagName":"h3"},{"title":"Investigating Furtherâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#investigating-further","content":" Okay so now it's time to open up that .pcap file and start the investigation, we are looking for the IP address of the machine that is carrying out the LLNMR poisoning attack. From our enumeration and information gathering, we know that the ports to check are UPD 5355 &amp; 137, so in Wireshark we will filter for that starting with port 5355, upd.port == 5355.  Looking at the above image we can see a series of normal requests to the DC01 server, the server is processing the requests form machines on the network as normal.Scrolling down further reveals some intriguing network traffic.Towards the end of the pcap file we can see that query responses are no longer coming from the DC01 server. Query responses are now being handled by 172.17.79.135, which is the IP address needed answer the task question.  ","version":null,"tagName":"h3"},{"title":"Task 2â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-2","content":" What is the hostname of the rogue machine?Okay so now that we know the IP address of the machine that is carrying out the LLMNR poisoning attack, it should be easy to find the hostname of the machine.  Taking what we have learned form the MITRE information on LLMNR poisoning attacks and how they are carried out, we know we can use DHCP to potentially find information on the threat actor machine. So, back into Wireshark we go, filtering for the IP address that we have found and narrowing down the search by scoping down to only DHCP protocol activity. With that we get 3 network events.With the 3 log events we can see that there was a DHCP request from this IP address. and digging into the log details we see that there is a field for the hostname of the requesting computer, in this case the threat actors machine hostname is kali. (Kali Linux bby!ðŸ˜Ž)  ","version":null,"tagName":"h2"},{"title":"Task 3â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-3","content":" Now we need to confirm whether the attacker captured the user's hash and it is crackable!! What is the username whose hash was captured?  ","version":null,"tagName":"h2"},{"title":"LLMNR Poisoning and Hashesâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#llmnr-poisoning-and-hashes","content":" Okay so how are LLMNR attacks related to password hashes and the cracking of them? For this lets go back to the MITRE documentation on the attack. Reading through the material, I found this snippet that explains how hashes can be obtained as a result LLMNR poisoning attacks:  (After initial LLMNR poisoning has been carried out.) If the requested host belongs to a resource that requires identification/authentication, the username and NTLMv2 hash will then be sent to the adversary controlled system. The adversary can then collect the hash information sent over the wire through tools that monitor the ports for traffic or throughÂ Network SniffingÂ and crack the hashes offline throughÂ Brute ForceÂ to obtain the plaintext passwords.  and also...  In some cases where an adversary has access to a system that is in the authentication path between systems or when automated scans that use credentials attempt to authenticate to an adversary controlled system, the NTLMv1/v2 hashes can be intercepted and relayed to access and execute code against a target system.  ","version":null,"tagName":"h3"},{"title":"Further investigationâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#further-investigation","content":" Okay so now that we know that the threat actor could potentially be exploiting LLMNR to carry out poisoning and a man-in-the-middle attack to obtain hashes and crack those hashes and attempt to login to a compromised account via NTLM, we will look for indicators of such via further Wireshark filtering.  First lets filter for NTLM traffic, and oh boy we find some clear indicators...Looks like we are getting some brute force traffic on the SMB port 412 and also multiple session setup requests on the user account Forela\\john.deacon, the final answer to the task question being john.deacon.  ","version":null,"tagName":"h3"},{"title":"Task 4â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-4","content":" In NTLM traffic we can see that the victim credentials were relayed multiple times to the attacker's machine. When were the hashes captured the First time?  Pretty straight forward, as we have already filtered for smb2 traffic. We can look at the time stamps and check for the first instance of the john.deacon user account hash being brute forced over the network.The brute forcing of the hash for user account john.deacon took place on 2024-06-24 11:18:30.  ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-5","content":" What was the typo made by the victim when navigating to the file share that caused his credentials to be leaked?  Okay so we have information that the user john.deacon made a typo in the SMB share why does this matter and how did it leak the credentials of the users account? This probably has to do with the LNMRR poisoning as smb share hostnames are resolved to IP addresses and where does that resolution happen, via DNS and in this case with the dual IP addressing protocol nature of the network, LNMRR. So lets take a look at those network logs.So we see some broadcast traffic of the server DC01 announcing it's presence. SMB servers have a feature that allows them to advertise their presence on a local network, for security this should probably be disabled as it allows threat actors to enumerate smb servers and shares and potentially exploit them.  Looking back at the network logs of the LLNMR attack, we can see that the victim that had their credentials compromised had mistakenly typed the hostname DCC01 when attempting to access the smb server/shares.  ","version":null,"tagName":"h2"},{"title":"Task 6â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-6","content":" To get the actual credentials of the victim user we need to stitch together multiple values from the ntlm negotiation packets. What is the NTLM server challenge value?  For this one a roped in ChatGPT for some clarification on the NTLM protocol and the structure of it's packets. The task charges us with finding the server challenge value and that, &quot;To get the actual credentials of the victim we need to stich together multiple values from the NTLM negotiation packets&quot;.  ","version":null,"tagName":"h2"},{"title":"Educating myself with ChatGPTâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#educating-myself-with-chatgpt","content":" I prompted ChatGPT with the following message:  Explain the structure of ntlm negotiation packets. The context for this task is that I am investigation a security incident, and I need to obtain the NTLM server challenge value that the threat actor obtained.  And ChatGPT proceeded to give me a wealth of information. More specifically, instructions on how to extract the server challenge value, nice! ðŸ˜Ž  [!NOTE] Steps to Extract the Server Challenge Value Capture NTLM Traffic: Use network monitoring tools like Wireshark to capture the traffic during the NTLM authentication process.Apply filters in Wireshark to isolate NTLM packets. The filter ntlmssp can be used to find these packets specifically. Locate the NTLM Challenge Message: Look for the message with a type field of 0x00000002, which indicates the NTLM challenge message. Extract the Server Challenge: The server challenge is located 8 bytes after the &quot;Negotiate Flags&quot; field.In Wireshark, expand the NTLMSSP fields within the NTLM challenge message to locate the &quot;Server Challenge&quot;.The value will be a 64-bit (8-byte) hexadecimal number (e.g., 0xA1B2C3D4E5F6A7B8). Verify the Challenge: Ensure that the challenge aligns with the expected structure, and cross-reference with other packets to see how the client responded using this challenge.  ","version":null,"tagName":"h3"},{"title":"The Solutionâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#the-solution","content":" ChatGPT broke it down for me and now I have the details I need to hunt for the answer, NTLM has a series of steps for the authentication process, there are 3 different packets, which are the following, Negotiation Message, Challenge Message, and Authentication Message. The NTLM Challenge packets will be the ones that we are targeting.  Back to Wireshark we filter for ntlmssp packets and we can see the Challenge Message packets clearly.Looking at the first of the challenge packets details, scrolling down to the NTLM specific parts of the packet we can see the first challenge message, from when the threat actor carried out their brute force of the users account.The NTLM server challenge value for the first challenge packet is 601019d191f054f1, which is the answer to the task question.  ","version":null,"tagName":"h3"},{"title":"Task 7â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-7","content":" Now doing something similar find the NTProofStr value.  Now our target is the NTProofStr value but, wait what is that? Looking back at the ChatGPT info there is no mention of this value in the information provided....  [!NOTE] Hey ChatGPT what is NTProofStr in relation to the NTLM protocol? Response:In the NTLM protocol, NTProofStr (often called NT Proof String) is a key component of the NTLMv2 authentication process. It is a critical part of the client's response during the authentication process, specifically in the NTLM Authenticate Message.  Cool, so now we need to target and filter for the ntlm authentication packets and look for the value of the NTProofStr.  Looking at the packet that came right after the first ntlm challenge, we see an NTLM authentication packet, attempting to authenticate the user john.deacon.Now looking at the details of the NTLM authentication packet, we see the response type, and also the NTProofStr value, which is c0cc803a6d9fb5a9082253a04dbd4cd4.  ","version":null,"tagName":"h2"},{"title":"Task 8â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-8","content":" To test the password complexity, try recovering the password from the information found from packet capture. This is a crucial step as this way we can find whether the attacker was able to crack this and how quickly.  So we need to recover the password? Well, okay lets research how to do that. ChatGPT comes into play again and I ask it the following:  [!NOTE] How do threat actors crack user passwords using the NTLM protocol?Response Highlights:NTLM hashes are representations of the userâ€™s password in hash form, which is used during authentication instead of the plaintext password. If an attacker can capture these hashes (e.g., through a network sniffing attack or by extracting them from compromised machines), they can attempt to crack them offline. If an attacker captures the NTLM hash aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fbb310bc9ef504a40265b1, they can attempt to use Hashcat with a wordlist to brute-force the plaintext password.  Looks like we have to gather the hashes from the NTLM packets and attempt to crack them with Hashcat. I spun up a Linux VM and proceeded to install hash cat and look for wordlists to use.  Running Hashcat for the first time with the -h flag(help menu) shows all the flags, parameters and how they can be used to crack hashes or complete other tasks. The list is expansive.  Looking for wordlists I found this resource on github, https://github.com/gmelodie/awesome-wordlists and proceeded to download the RockYou password list as the description read, The go-to wordlist for passwords.  After getting the wordlists and hashcat installed I looked for some guidance on basic usage of the cli app and found an article on freecodecamp https://www.freecodecamp.org/news/hacking-with-hashcat-a-practical-guide/. The syntax we should use to brute force and find that password should be the following  hashcat -m 0 -a0 hashes.txt rockyou.txt   ","version":null,"tagName":"h2"},{"title":"Cracking NTLMâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#cracking-ntlm","content":" I went ahead and created a folder that store the rockyou.txt and also the hashes.txt files. We need to gather the hashes from the .pcap file and place them in the hashes file so that HashCat can process them and find a match.  NTLM Challenge Responseâ€‹  After doing some research on the NTLM protocol and how threat actors exploit the way it works, in order to carry out Man-In-The-Middle attacks, I found that the NTLM Challenge Response is the field that contains the hash-based validation of the password, along with other information, like the NTProofStr value that we collected earlier.So I gathered all the NTLMv2 response hashes from the packet capture file and stored in the hashes.txt file, so that they can be access an processed using hashcat.There was an issue though, when attempting to run hashcat on the file, with the proper syntax, hashcat was presenting me with errors about the hash format.Here is the syntax that I used after looking at the documentation for hashcat and the guide on how to use it, that I found on freecodecamp.  hashcat -m 5600 -a 0 -o cracked.txt hashes.txt rockyou.txt   The -m 5600 flag and arg, tell hash cast to use the HMAC-MD5 hashing algorithm, which is the hashing method that NTLMv2 uses. The -a 0 configures hashcat to carry out a normal Dictionary Attack using the provided wordlist in the rockyou.txt file. Lastly, the -o flag specifies where the results of the process should be stored, which is inside of the cracked.txt file.  I began to dig into what the cause of the issue was and see how I could correct the formatting. Doing google searches and ChatGPT queries. I came across this video, which detailed, how to obtain the NTLMv2 hash, along with other information that hashcat required, as well has how to format the file that stored the information. Super useful!ðŸ˜„ Shoutout to Embrace The RedðŸ»    Looks like the format of the content in the file needs to be structured via the format:  username::domain::challenge_value::HMAC-MD5_value::NTLMv2Resposne(Without fist 16 bytes)   So I created a new file ntlm-hashes.txt and typed out the needed format. Time to gather the data from the packet capture file.  First we need the NTLM Server Challenge value. Looking at the packet capture this would be the first packet that is sent to the NTLM server, by the client, requesting authentication and access. I my case I am targeting the first 3 packets in the capture file, after filtering for ntlmssp.Second, we need the NTLMv2 Response, which we find in the same packet further down the packet details, just like in our previous attempt.Third, we need to obtain the HMAC-MD5 value for hashcat, according to the information in the video, the NTProofStr is the HMAC-MD5 value. It is also the first 16 bytes of the challenge response.And for the last two values, User and Domain, we scroll down further in the packet details to find those values under the domain name &amp; user name attributes.Here we have, the final result of gathering all the need attribute values stored in the ntlm-hashes.txt.  john.deacon::FORELA: 53b0e5778af9adfb:8573cf0b2b03b84ba6caef21cd43a303:010100000000000080e4d59406c6da0153b0e57....   Now we use hashcat to do an offline brute force of the NTLMv2 hash. Below is the refined command to run:  hashcat -a0 -m5600 ntlm-hashes.txt rockyou.txt   And here is the terminal output from the command and the resulting password for the user account.The answer to the task question is the password NotMyPassword0k?  ","version":null,"tagName":"h3"},{"title":"Task 9â€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#task-9","content":" Just to get more context surrounding the incident, what is the actual file share that the victim was trying to navigate to?  For this task we will need to take a look at the log files that lead up to the malicious event. We know that the user was attempting to access a file share but, entered the wrong file share path, which in turn lead to their account becoming compromised. In task 5 we found the typo that the user had mistakenly typed in, which was DCC01. Looking through the packet capture file, we can see that right before the LLMNR pensioning took place, the user was attempting to access the file share, \\\\DC01\\DC-Confidential, which is the answer to the Task 9 Question.  ","version":null,"tagName":"h2"},{"title":"Key Takeawaysâ€‹","type":1,"pageTitle":"Noxious (HTB-Sherlocks)","url":"/blog/Noxious-HTB-Sherlocks#key-takeaways","content":" LLMNR (Link-Local Multicast Name Resolution) is a protocol that is used in Windows networks, it allows for the resolution of local network hostnames to IP addresses when DNS is not available. It is susceptible to Man-in-the-middle (MITM) &amp; Poisoning Attacks, due to it's lack of verifying the identity of devices that respond to the name resolution requests. Poisoning of LLMNR takes place when a threat actor exploits this lack of verification and impersonates the the LLMNR requesting service, allowing for the threat actor to receive traffic flows that contain sensitive information, which in this case lead to an corresponding NTLMv2 hash brute force.NTLM(Windows New Technology LAN Manager) and it's Version 2 variant are used to authenticate users via a challenge-response mechanism. With NTLMv2 the challenge-response mechanism uses HMAC-MD5 hashes that can be obtained via traffic capture or Man-In-The-Middle attacks and used for offline brute forcing, using a number of tools that are available, including the tool which we used for this investigation, HashCat. NTLM as a protocol should be disabled as is has been deprecated by Microsoft, and there are more modern protocols like Kerberos that accomplish the same functionality while being secure.    Footnotesâ€‹ https://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution â†© https://www.aptive.co.uk/wp-content/uploads/2017/02/responder-llmnr-netbios-name-server-spoofing.png â†© https://attack.mitre.org/techniques/T1557/001/ â†© ","version":null,"tagName":"h2"},{"title":"Reaper(HTB-Sherlocks)","type":0,"sectionRef":"#","url":"/blog/Reaper-HTB-Sherlocks","content":"","keywords":"Hack The Box Sherlock Reaper incident response NTLM","version":null},{"title":"Lets get Labbingâ€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#lets-get-labbing","content":" Okay so I just discovered Hack The Box Sherlocks, they are Blue Team focused labs that test your SOC Analyst skills. Useful for sharping and displaying knowledge and skills. There looks to be a lot of them which is great, so I decided to jump right in and take a stab at the first lab, a retired lab called Reaper.  ","version":null,"tagName":"h2"},{"title":"Reaperâ€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#reaper","content":" So, I am on the page and ready to start. I proceeded to read through the scenario, which reads as follows:  Our SIEM alerted us to a suspicious logon event which needs to be looked at immediately . The alert details were that the IP Address and the Source Workstfation name were a mismatch .You are provided a network capture and event logs from the surrounding time around the incident timeframe. Corelate the given evidence and report back to your SOC Manager.  Then I downloaded the files for the lab and took a look at them. Here is what they look like:    Okay so we have a .evtx file which is most likely a Windows Log file and also a .pcapng file that is a network capture of the event.  Before I proceeded I was asking myself if I needed to spin up a Windows VM or this as the computer that I am using is running Ubuntu Linux. Also, during the Windows Event Log: Finding Evil module for the HTB CDSA, all .etvw files where opened using Windows tools like the Event Viewer, SilkETW, and the PowerShell cmd-let get-winevent. Now I know there are most likely tools for viewing of these logs on Linux but, for posterity I will use the tools I learned about. Guess it's time to spin up that Windows VM.  installed Gnome Boxes as I heard it was the most minimal type 2 hypervisor for Debian based Linux distros. Downloaded the latest Windows 10 ISO and completed the install. Landing at the desktop I installed spice-webav guest tools, this makes it easier to move files to and from the host to guest OS and vise versa. I also installed 7-Zip as the native Windows OS archive tool does not support password protected .zip files. WireShark was also installed on the machine for a nice GUI-based interface that I can use to filter and investigate the .pcap file mentioned above. And not bam, here we are at the desktop all ready to go all cyber detective and everything.    ","version":null,"tagName":"h2"},{"title":"Task 1: What is the IP Address for Forela-Wkstn001?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-1-what-is-the-ip-address-for-forela-wkstn001","content":" Okay, so the first question is asking us for the IP address of the computer hostname Forela-Wkstn001 so most likely we will be looking at the pcap file as that contains all of the network monitoring logs, which contain details of connections to and from the network, protocols used, IP addresses, MAC addresses etc.  Okay so with the pcap file open in WireShark and scrolling through without any filtering I can already see a log form the computer mentioned in the task info. Looks like the NetBios service running on our target machine was attempting to update information of some sort and we can clearly see the source IP address, which is 172.17.79.129.    ","version":null,"tagName":"h2"},{"title":"What is NetBios?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#what-is-netbios","content":" NetBios is a network protocol that is used for layer 5 (OSI Model) communication over a local network, this communication happens between computers on the local network exchanging data like DNS info, printer sharing, and session management. It's a legacy protocol that was used heavily on older versions of Windows but, now not so much. Note that Linux does not natively use NetBios in it's networking stack but, most distros of Linux have access to a tool called netbios-utils, a command-line utility for interacting with NetBios and other systems using it.  ","version":null,"tagName":"h3"},{"title":"Task 2: What is the IP Address for Forela-Wkstn002?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-2-what-is-the-ip-address-for-forela-wkstn002","content":" Task 2 is the same exact question but this time for computer Forela-Wkstn002. This time we will make use of WireSharks string search abilities.    And yet again we have more NetBios communication and the revealing of the source IP address of the machine, 172.17.79.136  ","version":null,"tagName":"h2"},{"title":"Task 3: Which user account's hash was stolen by attacker?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-3-which-user-accounts-hash-was-stolen-by-attacker","content":" Task 3 is to figure out which account had its' hash stolen. Wondering if this could be related to the old NetBios protocol being used. If we look at the logs provided and filter for Windows Logon events, Event Code: 4624, the last 3 entries look very suspicious.    Now if we take a look at the event we can see what looks to be a malicious logon. How do we know it was malicious though? Well, we can see that the Security ID, Account Name, Account Domain, and Logon ID all look to be invalid values. Scrolling down further, we can see more indicators of compromise.    Above we can see that a new user was logged on to, aurthur.kyle from the Domain FORELA. This is the first instance of this user logging on in the logs. Also NTLM was used for the logon as you can see from the next image.    ","version":null,"tagName":"h2"},{"title":"What is NTLMâ€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#what-is-ntlm","content":" NTLM is another legacy protocol (lol, sensing a pattern here), that was originally developed in 1990's and was used by the Windows OS as an authentication protocol, it was specifically useful for authenticating systems and users in environments where the domain controller was not available.  NTLM is also exploitable via Replay and Pass-The-Hash Attacks, and from the looks of it and taking into account the task question, I believe this is what took place.  ","version":null,"tagName":"h3"},{"title":"Task 4: What is the IP Address of Unknown Device used by the attacker to intercept credentials?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-4-what-is-the-ip-address-of-unknown-device-used-by-the-attacker-to-intercept-credentials","content":" This one was easy as the same set of logs that we looked at from the previous task can be used to answer this one. The set of logons using NTLM and the user account arthur.kyle all originated from the IP 172.17.79.135. This can be seen in the Network Information section of the provided windows log file and also in the PCAP file as well.  Filtering for the ntlmssp protocol in Wireshark displays logs pertaining to NTLM negotiation and NTLM authentication.    ","version":null,"tagName":"h2"},{"title":"Task 5: What was the fileshare navigated by the victim user account?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-5-what-was-the-fileshare-navigated-by-the-victim-user-account","content":" For this task I had already peeped that there were some events pertaining to SMB shares. I took a look at the hint for this one which read as follows:  Filter for smb2 traffic in wireshark. Search for keywords &quot;BAD_NETWORK_NAME&quot; in packet details.  Okay so lets filter for smb2 traffic. After applying the filter and scrolling down, I see the &quot;BAD_NETWORK_NAME&quot; string come up in a set of logs.    This reveals the SMB share that was navigated to, which was \\\\DCO01\\Trip.  ","version":null,"tagName":"h2"},{"title":"Task 6: What is the source port used to logon to target workstation using the compromised account?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-6-what-is-the-source-port-used-to-logon-to-target-workstation-using-the-compromised-account","content":" Another easy question as the information is contained in sections of both log files that we've looked at already. Image below shows the source port of the logon for the compromised account aurthur.kyle.    As we can see from the image above the source port for the malicious NTLM logon was port 40252, which is an ephemeral port, used for temporary outbound connections.  ","version":null,"tagName":"h2"},{"title":"Task 7: What is the Logon ID for the malicious session?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-7-what-is-the-logon-id-for-the-malicious-session","content":" This can also be found in the same event in the Windows Log file specifically in the New Logon section.  As you can see from the image, the Logon ID is 0x64A799  ","version":null,"tagName":"h2"},{"title":"Task 8: What is the workstation name and the source IP Address from which the malicious logon occur?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-8-what-is-the-workstation-name-and-the-source-ip-address-from-which-the-malicious-logon-occur","content":" Task description also states that, &quot;The detection was based on the mismatch of hostname and the assigned IP Address&quot;. Which I noticed as in the beginning tasks, we established that Forela-Wkstn001 had an IP of 172.17.79.129 and that Forela-Wkstn002 had an IP of 172.17.79.136. Looking at the log event for the malicious logon we find the following.    The logon attempt happened on the Forela-Wkstn002 machine but, from an IP address that is different, 172.17.79.135.  ","version":null,"tagName":"h2"},{"title":"Task 9: When did the malicious logon happened. Please make sure the timestamp is in UTC?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-9-when-did-the-malicious-logon-happened-please-make-sure-the-timestamp-is-in-utc","content":" Alright, so same log event and this time a different set of data needed. Also, we must note that the task requests us to change the time to UTC so, depending on the machine your are viewing the logs on, and it's configured time zone, the time of the actual event will need to be adjusted to take this into account.  I like in the EST time zone so, the time of the event in EST was 12:55:16, converting that into UTC we get, 04:55:16.    The final complete answer, including the date as well as the time was 2024-07-31 04:55:16.  ","version":null,"tagName":"h2"},{"title":"Task 10: What is the share Name accessed as part of the authentication process by the malicious tool used by the attacker?â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#task-10-what-is-the-share-name-accessed-as-part-of-the-authentication-process-by-the-malicious-tool-used-by-the-attacker","content":" The last and final task of the Sherlock lab. The answer I saw in passing while browsing through the the log looking for answers to other tasks and getting the lay of the land in terms of what took place. I found that the Windows event code for file shares is 5140 after a quick google search. I applied the filter to the log file in Event Viewer and got the following.    A single event that took place at the exact same time as the suspicious logon via NTLM, what a coincidenceðŸ˜. The share accessed was \\\\*\\IPC$.  ","version":null,"tagName":"h2"},{"title":"Mission Complete!â€‹","type":1,"pageTitle":"Reaper(HTB-Sherlocks)","url":"/blog/Reaper-HTB-Sherlocks#mission-complete","content":"  ","version":null,"tagName":"h2"},{"title":"RogueOne (HTB-Sherlocks)","type":0,"sectionRef":"#","url":"/blog/RogueOne-HTB-Sherlocks","content":"","keywords":"Hack The Box Sherlock RogueOne memory forensics Volatility","version":null},{"title":"Scenarioâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#scenario","content":" Your SIEM system generated multiple alerts in less than a minute, indicating potential C2 communication from Simon Stark's workstation. Despite Simon not noticing anything unusual, the IT team had him share screenshots of his task manager to check for any unusual processes. No suspicious processes were found, yet alerts about C2 communications persisted. The SOC manager then directed the immediate containment of the workstation and a memory dump for analysis. As a memory forensics expert, you are tasked with assisting the SOC team at Forela to investigate and resolve this urgent incident.  ","version":null,"tagName":"h2"},{"title":"What are C2 communicationsâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#what-are-c2-communications","content":" This term is new to me, so time to do some research to gain more context into the event. After doing some googling I found that C2 just stands for Command &amp; Control, meaning that the computer is potentially compromised and could be part of a botnet. Yikes!ðŸ˜¬  ","version":null,"tagName":"h3"},{"title":"The Provided Filesâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#the-provided-files","content":" For this investigation the zip file is 1gig in size. Looks like we will be sifting through a lot of data. The file stored inside of the zip file is a .mem file, which I have not used before but, makes sense as in the given scenario, it's stated that a memory dump is provided for analysis.  ","version":null,"tagName":"h3"},{"title":"Memory Analysis Software (Volatility)â€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#memory-analysis-software-volatility","content":" I looked into the different types of software used by SOC teams, to analyze .mem files and I came across Volatility Framework, an open-source tool that is used for memory forensics. I went ahead and followed the instructions on the github page for installing the needed dependencies(python3) and Volatility 3 on a Linux VM.I also needed to create a python virtual environment for use for volatility. Python virtual environments are used to isolate dependencies for projects, instead of installing dependencies globally, which is messy and could cause issues down the road. I went ahead and attempted to create and environment using the following command:  python3 -m venv venv   I was met with the following message that I did not have the needed package installed, python3.12-venv.I used the command provided along with sudo to install the needed package.  sudo apt install python3.12-venv -y   Now we need to activate the python environment via the following command.  source venv/bin/active   Our virtual python environment should now be active, you can observe this via the terminal output, which now includes (venv).  And finally, as you can see from the image above, we can now run volatility commands.  ","version":null,"tagName":"h3"},{"title":"Task 1 & 2â€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#task-1--2","content":" Please identify the malicious process and confirm process id of malicious process.The SOC team believe the malicious process may spawned another process which enabled threat actor to execute commands. What is the process ID of that child process?  So now that we have volatility3 installed and running we can run commands to accomplish various functions. Doing python vol.py -h brings up the following output.Which provides a useful list of flags, arguments and parameters that can be used with the command line utility. The flag, -f allows for specifying of a file to process and analyze, this then must be followed with a value for the plugin to be used on the file. In the case of this question we need to look at the processes that were running on the machine at the time the SOC team was alerted and captured a memory dump of the affected machine. Looking at the list of plugins available from the fresh install, I can see that there is a plugin called windows.pslist, which allows listing of processes that are present in the target windows memory image.So now we craft the final command to get the processes, we call python to run vol.py, adding the -f flag and specifying the target file which is, in my case located on an attached folder share to the VM. File path to the memory dump we need to analyze for this lab is /media/sf_D_DRIVE/HTB-Sherlocks/RogueOne/20230810.mem. Then we envoke the plugin we need, so that we can get the intended output, windows.pslist. The final command:  python vol.py -f /media/sf_D_DRIVE/HTB-Sherlocks/RogueOne/20230810.mem windows.pslist   Running the command gives us a list of all of the processes, that of which there are many.  I went ahead and ran the program again by this time piping the output to a text file that could be searched through and analyzes in greater detail.  python vol.py -f /media/sf_D_DRIVE/HTB-Sherlocks/RogueOne/20230810.mem windows.pslist &gt; pslist_output.txt   After running the above command we can now use the cat and grep command line utilities to display and filter the content contained within the created text file.  ","version":null,"tagName":"h2"},{"title":"Investigating the Outputâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#investigating-the-output","content":" Looking through the list of processes there are no processes that are named suspiciously at first glance. We do have two Process ID (PID) rows though, one for regular PID values and a second for a Parent Process ID (PPID) which are processes that have been spawned from other running processes. Threat actors may do what is called, Living off The Land (LOTL) which is a technique that allows threat actors obfuscate there activity and avoid detection via using the software included in the operating system and whatever applications the user has installed that may be vulnerable.  Taking all of that into account, if we look toward the bottom of the pslist_output file, we can see two processes for cmd.exe, the running of command prompt it's self is not a red flag, though normal end-users for the most part will not be launching that application on a regular basis. The red flag in this case are the parent processes that have spawned both instances of cmd.exe. Lets use both the cat &amp; grep cmd line utilities to filter the pslist_output.txt file and gain more insight.  Using cat to display the output and grep to filter for cmd.exe we can see that the parent PID's, which are 936 &amp; 6812. Filtering for both of these PIDs brings up two distinct svchost.exe processes.  ","version":null,"tagName":"h3"},{"title":"svchost.exeâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#svchostexe","content":" Digging into the information on the svchost process, I found that it's known as the Service Host. It is an integral system process for the Windows Operating system and acts as a host/manager for DLL-Based Windows Services. Essentially is manages background services allowing the OS to run efficiently.  I also found that svchost.exe spawning the cmd.exe process is not considered to be normal behavior for the process and is a clear indicator of compromise. Also when filtering for all of the svchost.exe processes, they all share the same PPID except for the svchost.exe processes that spawned cmd.exe.  ","version":null,"tagName":"h3"},{"title":"The Answersâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#the-answers","content":" So now that we have done our investigation and analysis of the processes that were running at the time of detection, we can answer the questions in both Task 1 and in Task 2.  Please identify the malicious process and confirm process id of malicious process.â€‹  The malicious process in this case is the svchost.exe (6812) process that spawned the cmd.exe (4364). Since they ask for the process ID as input, it would be 6812.  The SOC team believe the malicious process may spawned another process which enabled threat actor to execute commands. What is the process ID of that child process?â€‹  That would be the child process, that svchost.exe spawned, the cmd.exe process that has a PID of 4364.  ","version":null,"tagName":"h3"},{"title":"Task 3â€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#task-3","content":" The reverse engineering team need the malicious file sample to analyze. Your SOC manager instructed you to find the hash of the file and then forward the sample to reverse engineering team. What's the md5 hash of the malicious file?  We need to get the MD5 hash of the malicious svchost.exe file. I ran volatility3 with the -h flag so that I could see all the the options and plugins available. I narrowed down the search using grep to filter for any occurrences of the the word file. This should provide a function/plugin that will allow us to see the files in the filesystem of the memory dump file.Looks there is a function/plugin called windows.filescan, which after some research, I found that it allows for listing of all file objects that were found in memory at the time of the dump.  Using this function/plugin, along with grep filter the output and place it into a text file, using the command below.  python vol.py -f python vol.py -f /media/sf_D_DRIVE/HTB-Sherlocks/RogueOne/20230810.mem windows.filescan | grep svchost.exe &gt; svchost_filescan.txt   Looking through the svchost_filescan.txt I can clearly see an svchost.exe file located in a folder that is not in the Windows directory, located in a the user, simon-stark's, downloads folder.   ","version":null,"tagName":"h2"},{"title":"File Extractionâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#file-extraction","content":" We now know the location of the malicious file but, are we able to extract it out of the memory dump file? Does volatility3 have the functionality to do this? The answer to both questions is yes.  When I was looking up functions/plugins to use in order to list all of the files in the memory dump, I cam across the plugin windows.dumpfiles.Now we craft the complete command so that we can extract the file out of the memory dump.  python vol.py -f /media/sf_D_DRIVE/HTB-Sherlocks/RogueOne/20230810.mem windows.dumpfiles --pid 6812   Above you can see that the svchost.exe was dumped out an an .img file, along with the DLLs that the application must have been accessing to run. The .img file is a raw dump format that is a binary blob of the file as it appeared in memory at the time of capture.  ","version":null,"tagName":"h3"},{"title":"Hashingâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#hashing","content":" Now that we have the image file of the malicious file we need to get a hash of the file to provide to the reverse engineering team mentioned in the task. To do this we can use the pre-installed md5sum command line utility. Most distributions of Linux have this utility installed by default as a part of the GNU Core Utilities package.  The command used to get the md5sum is as follows:  md5sum file.0x9e8b91ec0140.0x9e8b957f24c0.ImageSectionObject.svchost.exe.img   Which gives use the output, containing the MD5 hash and the filename. The hash being 5bd547c6f5bfc4858fe62c8867acfbb5, which is the answer to Task 3.  ","version":null,"tagName":"h3"},{"title":"Task 4â€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#task-4","content":" In order to find the scope of the incident, the SOC manager has deployed a threat hunting team to sweep across the environment for any indicator of compromise. It would be a great help to the team if you are able to confirm the C2 IP address and ports so our team can utilize these in their sweep.  This task requires us to dig into the windows.netscan plugin that is pre-installed with Volatility3. With the Linux Mint VM that I had setup, volatility was not detecting that the memory dump file had data that could be scanned with the plugin, so I created a new VM and installed Kali Purple, which is a Linux distro targeted at purple/blue team use, which is more suitable for carrying out investigations and also has a lot of SOC Analyst software pre-installed.  I believe now, after looking into the situation, that the file had been only partially extracted from the archive, the memory dump that I was accessing with volatility3 was only 2.7gb in size, with the file in kali purple, after fully being extracted from the archive, was around 4gb in size. Whoops!ðŸ˜  So, here is the truncated output.The first thing that jumps out to be is a connection to an IP address, 13.127.155.166 with the port 8888.From what I know about services, networking, and ports, and from running some services on home server, port 8888 is used for some self-hosted services. I did some research on the port and what it has been historically used for. WhatPortIs.com states that the port is commonly used for http &amp; https traffic as an alternative port, if there are multiple services providing http/https functionality. SpeedGuide.net states that the port is used for &quot;allhttpd&quot; but, also states that it could be related to malware and trojans, things are looking fishy ðŸŸ.  Moving on to the IP address, I did some research on websites that contained databases of IP addresses that could be associated with botnets &amp; C2 Command and Control servers. I landed at Cisco Talos, which allows for searching of IP addresses, providing information on if the IP address has been used in malicious acts, exactly what we need.  The search itself did not turn up anything of note, IP address originates from Mumbai, India bit the IP address is rated as neutral in nature.  Judging from this entry being the only entry from an svchost.exe process and it's the only one to be connecting to a foreign IP on a non-standard port, we should be on the right track. I went ahead and entered the IP found and port, 13.127.155.166:8888. This turned out to be the correct answer.  ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#task-5","content":" We need a timeline to help us scope out the incident and help the wider DFIR team to perform root cause analysis. Can you confirm time the process was executed and C2 channel was established?To get the answer for this task we can look at the time that the connection was established. In the previous question we used the windows.netstat volatility plugin to get a list of connections that were established leading up to the event. It also provided us with timestamps for when these connections took place.  Looking back at the above image, we can see that the time of connection to the C2 server was at 10/08/2023 11:30:03. Note that we could have also gotten this answer via using the windows.pstree plugin, which allows for checking of parent-child relationships and provides timestamps as to when processes where initially executed.   ","version":null,"tagName":"h2"},{"title":"Task 6â€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#task-6","content":" What is the memory offset of the malicious process?The offset can be found via the above mentioned windows.pstree. It allows us to see, as mentioned before, parent-child relationships and when a process was executed. Looking at the malicious svchost.exe that after being launched created a child cmd.exe process, we can get the offset of the malicious file, which is 0x9e8b87762080.  ","version":null,"tagName":"h2"},{"title":"Task 7â€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#task-7","content":" You successfully analyzed a memory dump and received praise from your manager. The following day, your manager requests an update on the malicious file. You check VirusTotal and find that the file has already been uploaded, likely by the reverse engineering team. Your task is to determine when the sample was first submitted to VirusTotal.Nice, okay so we can use the hash of the malicious svchost.exe file that we gathered as the result of [[#Task 3]], which was 5bd547c6f5bfc4858fe62c8867acfbb5. So, we load up VirusTotal and navigate to search and input the hash.  And we get a result, the file indeed is on virustotal, and is indeed malicious in nature, as we have already confirmed.  Navigating to the details section of the entry in virustotal, and it looks like the file was first submitted on 2023-08-10 11:58:10 UTC. ðŸŽ‰  ","version":null,"tagName":"h2"},{"title":"Key Takeawaysâ€‹","type":1,"pageTitle":"RogueOne (HTB-Sherlocks)","url":"/blog/RogueOne-HTB-Sherlocks#key-takeaways","content":" The volatility framework is a powerful tool in memory forensics that can be used on Windows, Mac, &amp; Linux.Volatility has a host of plugins that work with supported Operating Systems, allowing for in depth memory analysis and investigation.Capturing images of a compromised systems filesystem and memory is a critical component in the incident response process, providing ways to investigate possible compromised machines, without the need to keep them on the network.Cisco Talos is a repository of IP address information. Providing insights on if a particular IP address is a part of a botnet or has been used in malicious activities. ","version":null,"tagName":"h2"},{"title":"The Journey So Far","type":0,"sectionRef":"#","url":"/blog/The Journey So Far","content":"","keywords":"cybersecurity certifications career SC-300 Google Cybersecurity","version":null},{"title":"Whats next?â€‹","type":1,"pageTitle":"The Journey So Far","url":"/blog/The Journey So Far#whats-next","content":" From here I hae a few options. Since completing the GCP, i have a 30% off voucher to take the CompTIA Security+. I have already started to study for it, which shouldn't take too much time since the GCP covers topics that are a part of the domains covered in the Sec+. I also know that the cloud is becoming an ever prevalent way for Organizations to role out services, apps, and infrastructure, so it's important to know how to carry out security in the cloud. With that in regard I have taking steps toward the AZ-900, finishing the Microsoft Learn course content and scheduling the exam for tomorrow 8/2/2024.  ","version":null,"tagName":"h2"},{"title":"Hack the Box - Certified Defensive Security Analystâ€‹","type":1,"pageTitle":"The Journey So Far","url":"/blog/The Journey So Far#hack-the-box---certified-defensive-security-analyst","content":" Hack the Box is a well known cyber range and I have some experience exploring their modules and also using TryHackMe. What draws me to the certification is that exam test is all practical. I will be investigating a security incident, performing an analysis, and writing out a report on findings. The exam is graded based on the quality of the report and how thorough the findings are, it sounds like just the type of challenge I need right now.   ","version":null,"tagName":"h3"},{"title":"Unit42 (HTB-Sherlock)","type":0,"sectionRef":"#","url":"/blog/Unit42-Sherlock","content":"","keywords":"Hack The Box Sherlock Unit42 Sysmon threat detection","version":null},{"title":"Scenarioâ€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#scenario","content":" In this Sherlock, you will familiarize yourself with Sysmon logs and various useful EventIDs for identifying and analyzing malicious activities on a Windows system. Palo Alto's Unit42 recently conducted research on an UltraVNC campaign, wherein attackers utilized a backdoored version of UltraVNC to maintain access to systems. This lab is inspired by that campaign and guides participants through the initial access stage of the campaign.  ","version":null,"tagName":"h2"},{"title":"The Filesâ€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#the-files","content":" Inside the zip file for this investigation, we are provided with a single Windows log file, from the Sysmon Operational log provider.    ","version":null,"tagName":"h2"},{"title":"Task 1â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-1","content":" How many Event logs were there with Event ID 11?  For this I opted to make use of PowerShell, specifically the cmdlet Get-WinEvent. Referencing this amazing PDF created by the SANS institute, I was able to use the -Path argument to point the Cmdlet to the provided .evtx file. I also applied filtering and counting of events via | Group-Object id -NoElement | sort count. The complete command I created is below, along with an explanation of each element.  Get-WinEvent -Path 'C:\\Sherlocks\\Unit 42\\Microsoft-Windows-Sysmon-Operational.evtx' | Group-Object id -NoElement | sort count   Get-WinEvent -Path: Tells the Get-WinEvent cmdlet to target a specific event log file.Group-Object: Will display objects based on a the value of a property that is given as an argument, in this case the id property.-NoElement: Tells the Group-Object command not to include the objects in the output.sort count: Enables sorting via a value in this case the count of events.  And here is the output of the complete command.    As you can see from the output we have a list of event IDs and their counts in descending order, at the bottom the event id of 11 has a count of 56 events.    ","version":null,"tagName":"h2"},{"title":"Task 2â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-2","content":" Whenever a process is created in memory, an event with Event ID 1 is recorded with details such as command line, hashes, process path, parent process path, etc. This information is very useful for an analyst because it allows us to see all programs executed on a system, which means we can spot any malicious processes being executed. What is the malicious process that infected the victim's system?  For this I will be parsing the provided .evtx file using EvtxECmd and converting it into a .csv file. After the parsing/conversion we will be able to view and filter the file in Timeline Explorer, providing a clearer view of the log data and more complete searching and filtering.    Above I ran EvtxECMD with the needed parameters and had it generate a .csv file from the provided log file.    I then opened the file in Timeline Explorer, displaying all the events contained in the log file, presented in groups sorted by event ID.    Looking at all of the 6 events pertaining to Event ID 1, we can see a suspicious process creation event invoked from the directory location and file, C:\\Users\\CyberJunkie\\Downloads\\Preventivo24.02.14.exe.exe which turns out to be the task flag and the malicious process that infected the system.    ","version":null,"tagName":"h2"},{"title":"Task 3â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-3","content":" Which Cloud drive was used to distribute the malware?  Hmm, okay so we need to find either a directory or some sort of network communication to a cloud service to pin down the flag for this task. Lets take a look at all the events that are contained in the log, just so that we know what we have to work with. Below I have included details for all the Sysmon events contained in our log file and what data they contain.    Sysmon Event ID 1: We already know from the previous tasks that this event is logged on creation of a Windows processes.Sysmon Event ID 2: Changing of file creation time.Sysmon Event ID 3: Network connection made by process.Sysmon Event ID 5: Windows process termination.Sysmon Event ID 7: DLL loaded into a process.Sysmon Event ID 10: Process accessing another process.Sysmon Event ID 11: File creation/File Overwritten.Sysmon Event ID 12: Creation and deletion of registry events.Sysmon Event ID 13: Modification of registry values.Sysmon Event ID 15: creation of file stream and hash of file contents.Sysmon Event ID 17: Named Pipe created (interprocess communication).Sysmon Event ID 22: DNS Queries.Sysmon Event ID 23: File deletion and archiving.Sysmon Event ID 26: File deletion logged.  Now we know what event data we have contained in the logs, the task requires us to find what cloud drive was used. Usage of the cloud at all means communication over the internet, meaning that a DNS query should have been made to the cloud service for connection and communication. Lets take a look at Sysmon Event ID 22.    Above we can see that we have 3 logs for Sysmon Event 22. All of the events were triggered by the same user account that launched the malware and all of the events took place around the same time.    Looking at the payload data contained in the logs we have the Image/Process that initiated the DNS query and also the QueryName/Hostname value.    I sorted the events by time and found that we had queries for dl.dropboxusercontent.com &amp; d.dropbox.com. Directly after, we have a query from the malware process, attempting to resolve www.example.com. From this information, we can confirm that the cloud drive/service that was being used was dropbox.    ","version":null,"tagName":"h2"},{"title":"Task 4â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-4","content":" For many of the files it wrote to disk, the initial malicious file used a defense evasion technique called Time Stomping, where the file creation date is changed to make it appear older and blend in with other files. What was the timestamp changed to for the PDF file?  We know that the Sysmon Event 2 logs the file creation times. We should be able to look at these logs for a PDF file that looks to be older than it really is.    Above I have filtered for all the Sysmon Event 2 logs, and we have a list of file creations. Looking at the file creations and their originating process, we can see that the malware created a host of files on the system. The most notable is the only PDF file that was created and logged which is found at C:\\Users\\CyberJunkie\\AppData\\Roaming\\Photo and Fax Vn\\Photo and vn 1.1.2\\install\\F97891C\\TempFolder\\~.pdf.    And now looking at the creation time of the PDF file we can see that the creation time logged was 2024-01-14 08:10:06.    ","version":null,"tagName":"h2"},{"title":"Task 5â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-5","content":" The malicious file dropped a few files on disk. Where was &quot;once.cmd&quot; created on disk? Please answer with the full path along with the filename.  In the previous task, we filtered for Sysmon Event 2 logs and we noticed that the malware created a few files on the affected host system. One of which was the PDF file we observed the creation time of, another was this file, once.md.    Looking again at the filtered logs we have an entry for the file creation of once.md and we can see the full path in which the file was created. The complete file path is C:\\Users\\CyberJunkie\\AppData\\Roaming\\Photo and Fax Vn\\Photo and vn 1.1.2\\install\\F97891C\\WindowsVolume\\Games\\once.cmd.    ","version":null,"tagName":"h2"},{"title":"Task 6â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-6","content":" The malicious file attempted to reach a dummy domain, most likely to check the internet connection status. What domain name did it try to connect to?  This one is simple, in Task 3, we were asked, what cloud service was used to distribute the malware. We observed a timeline of Sysmon Event 22 logs, in which the affected computer attempted to reach two Dropbox domains and also the domain www.example.com, of which I annotated in the image that it was potentially an attempt for the malware to check for internet connection before downloading more malicious files. I have included the image below.      ","version":null,"tagName":"h2"},{"title":"Task 7â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-7","content":" Which IP address did the malicious process try to reach out to?  Referencing the Sysmon Event ID, present in the provided log file, we should be able to make use of Sysmon Event 3, which logs data pertaining to a process making a network connection.    Filtering for Sysmon Event 3 there is only a single log entry, and it is related to the malicious file that was run and infected the host system.    Scrolling to the payload data and executable info we confirm that the log was for the malicious file, and we also see that the destination IP address the malware was attempting to connect to was, 93.184.216.34.    ","version":null,"tagName":"h2"},{"title":"Task 8â€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#task-8","content":" The malicious process terminated itself after infecting the PC with a backdoored variant of UltraVNC. When did the process terminate itself?  Sysmon Event 5 correlates to the termination of processes. It is safe to assume that if we have any logs for this type of event, that there would be some useful information pertaining to the termination of the malware that infected the host.    Filtering for Sysmon Event 5 we have a single log entry, of which the executable info for the log entry points to the malicious file from the previous tasks.      Now looking at the payload information for this log entry we find the time &amp; date of the process termination, which is 2024-02-14 03:41:58. Note that double clicking on a cell in Timeline Explorer will present the full contents of the cell.      ","version":null,"tagName":"h2"},{"title":"Timeline of Eventsâ€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#timeline-of-events","content":" 2024-02-14 03:41:25 - User on the soon-to-be-infected machine downloads malicious file from Dropbox cloud storage using Firefox web browser. Malicious file is named Preventivo24.02.14.exe.exe, and is downloaded to the users downloads folder.2024-02-14 03:41:48 - User executes the malicious file. Malware attempts to access www.example.com, possibly to test internet connection.2024-02-14 03:41:57 - Malware creates network connection to IP 93.184.216.34.2024-02-14 03:41:57 - Preventivo24.02.14.exe.exe process downloads malicious files and scripts to C:\\Users\\CyberJunkie\\AppData\\Roaming\\Photo and Fax Vn\\Photo and vn 1.1.2\\install\\F97891C\\ creating sub-directories as well.2024-02-14 03:41:57 - Preventivo24.02.14.exe.exe executes installer file that was downloaded via the command, infecting the system: &quot;C:\\Windows\\system32\\msiexec.exe&quot; /i &quot;C:\\Users\\CyberJunkie\\AppData\\Roaming\\Photo and Fax Vn\\Photo and vn 1.1.2\\install\\F97891C\\main1.msi&quot; AI_SETUPEXEPATH=C:\\Users\\CyberJunkie\\Downloads\\Preventivo24.02.14.exe.exe SETUPEXEDIR=C:\\Users\\CyberJunkie\\Downloads\\ EXE_CMD_LINE=&quot;/exenoupdates /forcecleanup /wintime 1707880560 &quot; AI_EUIMSI=&quot;&quot; 2024-02-14 03:41:58 - Preventivo24.02.14.exe.exe deletes all downloaded files, directories, and scripts downloaded from IP address.2024-02-14 03:41:58 - Preventivo24.02.14.exe.exe terminates its process after downloading malicious files from IP address.  ","version":null,"tagName":"h2"},{"title":"ðŸ”‘ Key Takeawaysâ€‹","type":1,"pageTitle":"Unit42 (HTB-Sherlock)","url":"/blog/Unit42-Sherlock#-key-takeaways","content":" Effective Use of Sysmon Logs: Understanding Sysmon event IDs is critical for detecting suspicious behavior.PowerShell for Log Analysis: Leveraging Get-WinEvent, filtering of a given log file can be accomplished.Timelining with EvtxECmd &amp; Timeline Explorer: Parsing .evtx files into .csv and analyzing them in Timeline Explorer provided a powerful method to sift through and correlate event data. ","version":null,"tagName":"h2"},{"title":"Deploying & Scanning with Qualys Cloud Agent","type":0,"sectionRef":"#","url":"/docs/Qualys Vulnerability Management/Qualys Cloud Agent","content":"","keywords":"Qualys Cloud Vulnerability Scanning Windows","version":"Next"},{"title":"Installationâ€‹","type":1,"pageTitle":"Deploying & Scanning with Qualys Cloud Agent","url":"/docs/Qualys Vulnerability Management/Qualys Cloud Agent#installation","content":" To install the Qualys cloud agent software on a Windows host navigate to the Qualys dashboard and click on the modules drop down in the top right of the page and select Cloud Agent.  Click on Download &amp; Install Agents.  Now give our cloud agent/ activation key a name, in my case I will be calling this agent Vulnerable Windows 10. I also selected provision key for the agent, the community edition comes with 20 licenses for agents and devices.  Hit generate and you will be presented with a list of platforms to install the cloud agent software on. In my case I will be selecting Windows. Then an activation key will be generated and a Windows cmd command will be presented that needs to be run to install the agent application. Note: The agent application can not be installed without the cmd command.  Back at our vulnerable Windows 10 VM I have transferred the Qualys agent installer to the machine and also a text file that contains the cmd command for installation. We need to run cmd prompt as admin to get this to install correctly as the agent needs elevated privileges on the systems that it runs on to carry out scanning and reporting.  And here we are installing the software from cmd prompt. Install finished successfully.  Now in theory we should be able to see our agent reporting that it's connected and successfully phoning back home to Qualys. Checking back at Qualys, it's confirmed we have our agent reporting back, the key we used now has one agent active on it.  Going to the Agents section we also find that we have a our Vulnerable Windows 10 machine actively connected.  Lastly we need to activate the agent that we installed on our Windows machine for vulnerability management. It's very straight forward, from the Agents page select the agent, then click on the actions button and hit Activate Agent.  You will be presented with a Window prompting if you want to activate this agent for the Vulnerability Management module, select it and hit activate.  Now that we have added our agent to the vulnerability management module, Qualys is going to download the some files, specifically the vulnerability management manifest to the endpoints that have the agent installed. This can take some time to complete so I let Qualys sit for a bit and came back the next day. Looking at our list of agents from the agent management section, we can see that the manifest successfully downloaded and also that our first scan was run.  ","version":"Next","tagName":"h2"},{"title":"Agent Scanning & Resultsâ€‹","type":1,"pageTitle":"Deploying & Scanning with Qualys Cloud Agent","url":"/docs/Qualys Vulnerability Management/Qualys Cloud Agent#agent-scanning--results","content":" Clicking on on our vulnerable windows machines hostname form the menu, we can see all of the information that has been populated from the agents initial scan and also from an scheduled vulnerability scan. Agents in Qualys are assigned configuration policies that dictate the cadence of scanning and the type of scanning that takes place. This agent was configured using the default configuration.  As you can see form the screenshot above, there is a lot of information that the Qualys agent software scans for, system info, network info, open ports, lists of installed software on the host, and most importantly, found vulnerabilities.  Looking at the installed software, we can see the old software that we installed on our Proxmox VM, which in should also lead to rather critical vulnerabilities being reported. The software versions installed are mostly from around 2013. ðŸ˜†  Now for the vulnerabilities discovered, and yes we can see that Qualys has found 327 Critical Vulnerabilities. Ouch!  Digging deeper into the Vulnerabilities found, we can see a large amount of critical level 5 vulnerabilities form the outdated Firefox install, which makes sense as it interfaces with the open internet, and a few from VLC and also some from critical Windows updates not being installed. ","version":"Next","tagName":"h2"},{"title":"Building a CyberSecurity Home Lab","type":0,"sectionRef":"#","url":"/docs/Home Lab/homelab01","content":"","keywords":"Homelab Cyber tailscale detectionlab proxmox clustering","version":"Next"},{"title":"Zimaboard Firewallâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#zimaboard-firewall","content":" The first addition to the top rack slot will be a Zimaboard. Why a Zimaboard you ask? Proxmox and other bare metal hypervisors have the ability to carry out Software Defined networking to manage a virtualized network for all logical hosts. While this a convenient implementation to have, I would like to achieve a more real world configuration via the use of a hardware-based PFSense firewall, PFSense is a router/firewall operating system based on FreeBSD and maintained by the NetGate company. The OS has a host of features including VLANs, NAT, Port Forwarding, ACLs, QoS, etc, which should be everything I need.  The Zimaboard, which conveniently has two ethernet ports on the front, and has enough horsepower for out routing/firewall needs will be the host for the PFSense OS. I needed to find a way to mount the device in the rack. Looking through Printables again, I found a model created by user @MartinRowan for mounting the Zimaboard to a rack.  ","version":"Next","tagName":"h2"},{"title":"Installing PFSenseâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#installing-pfsense","content":" Installing PFSense was very straight forward, download the compressed image file, extract the image file, and image a USB flash drive via Belina Etcher, or in this case, rufus. Hit F11 while the Zimaboard boots and select the flash drive as the intended boot device. Boot into the NetGate installer and configure your initial network settings. In my case, I have configured the router/firewall with these network settings:  Network: 10.1.1.1/24Range Start: 10.1.1.10Range End: 10.1.1.100WAN Interface: RE0LAN Interface: RE1  For now I have not configured anything else on PFSense. No ACL's or Firewall rules. The goal is to get everything up and running and communicating, and then while fleshing out projects I will enable different settings to simulate different types of network environments.  Network Topologyâ€‹  Here is a breakdown of the Network Topology as it's been configure at the current moment.  Right-Click open in a new tab to see the image larger.  ","version":"Next","tagName":"h3"},{"title":"Tenda Switchâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#tenda-switch","content":" For switching and interconnecting of physical and logical hosts, we will be using a basic 5 port Tenda switch. The switch is unmanaged and not VLAN aware, which will suit or needs for the time being.  Rack Mountâ€‹  I opted to create a simple rack mount for the switch using OnShape, a web based CAD software that's free for students and creators. I took measurements of the switch and noted where the ports where and the power terminal so that everything was accessible.Here is the final product, if you ever find your self in need of a rack mount for this specific model of switch you can find that model [here] for download.  Also, here is the completed rack with the Tenda switch and Zimaboard installed. ðŸ˜  ","version":"Next","tagName":"h3"},{"title":"Proxmox Installâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#proxmox-install","content":" I went ahead and installed Proxmox on all 3 computers, configuring them with static IP addresses, documenting them as I go. Configured the root/admin password on all hosts had then boot up to the login screen. By default Proxmox has ssh running so, now that all the hypervisor hosts are on the network, I can remote into them via the terminal.  ","version":"Next","tagName":"h2"},{"title":"Tailscaleâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#tailscale","content":" Tailscale is my solution for remote access to the lab. It's a VPN implementation that has a host of features that make it easy to connect to your home network via mesh VPN tunnels. It uses Wireguard under the hood to accomplish this, allowing me to access the lab from my personal computer, while I am on another network. Below are all the node details, after network config and Tailscale install. I also installed Tailscale on my PFSense host as well.  Hostname\tIP Address\tTailnet Addresslab01.local\t10.1.1.11\t100.90.166.52 lab02.local\t10..1.1.12\t100.123.54.72 lab03.local\t10.1.1.13\t100.125.134.1 pfsense-pve-gateway\t10.1.1.1\t100.65.75.85  Great thing about Tailscale is the Magic DNS functionality which allows me to connect to the nodes via there hostname anywhere. So even if I am off-site, I can connect to tailscale and ssh or load the web interface of Proxmox via the hostname.  ","version":"Next","tagName":"h2"},{"title":"Proxmox Config & Clusteringâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#proxmox-config--clustering","content":" Now for the fun part, getting all of these nodes into a cluster. Looking at the Proxmox documentation the only requirement is that the nodes be running Proxmox and have their final hostname &amp; IP address configurations. In the Proxmox GUI we need to navigate to Datacenter&gt;Cluster.  I gave the cluster super original name of Sec-Lab-ClusterðŸ˜œ, and proceeded on to the next step.    Okay so the cluster has been created. Not it's time to add the other nodes to the Proxmox Cluster and get them talking to one another and sharing resources. For that, we need to login to each other the other two clusters and join them to the cluster established on Lab01-pve but, first there is some info that we need handy. We need to login to Lab01-pve and get the cluster info to add to the other nodes. So, to do this we go to Datacenter&gt;Cluster&gt;Join Information.  Then on the joining node we go to Datacater&gt;Cluster&gt;Join Cluster and paste in the information. Pasting the info we copied from Lab01-pve brings up all the required info for joining the node, minus the root password. We input that and then join the node to the cluster. I did this again on the last and final node and here is the result:  All 3 nodes in a single cluster. ðŸ˜Ž  ","version":"Next","tagName":"h2"},{"title":"So What's Next?â€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#so-whats-next","content":" That's a good question. So my plan is to follow all the the domains of the Security+ and also the SC-300 from Microsoft, both of which are certifications that I currently hold. Applying the learning I have done to hands on projects. I am specifically excited to tackle a PKI project as the topic interested me while I was studying for the Security+ SY0-701. Update December 2024: Security+ Certification has been obtained.  ","version":"Next","tagName":"h2"},{"title":"Active Directory Labsâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#active-directory-labs","content":" Since starting my learning for the Hack The Box CDSA, I have completed the module, Windows Attack &amp; Defense which hosts a large amount of information about attacks that target Active Directory.  ","version":"Next","tagName":"h3"},{"title":"Qualys Vulnerability Managementâ€‹","type":1,"pageTitle":"Building a CyberSecurity Home Lab","url":"/docs/Home Lab/homelab01#qualys-vulnerability-management","content":" At my current organization, we are implementing Qualys for endpoint vulnerability management. So, it would make sense to learn the platform and how to deploy scanning on end-points. ","version":"Next","tagName":"h3"},{"title":"Projects","type":0,"sectionRef":"#","url":"/docs/intro","content":"","keywords":"cybersecurity projects portfolio Dario Cruz","version":"Next"},{"title":"Explore My Workâ€‹","type":1,"pageTitle":"Projects","url":"/docs/intro#explore-my-work","content":" Use the sidebar on the left to navigate through various project categories, each reflecting a unique aspect of my cybersecurity endeavors. The pages inside of each project can be navigated back and forth via next and previous buttons at the bottom of each page.  ","version":"Next","tagName":"h2"},{"title":"Have Questions?â€‹","type":1,"pageTitle":"Projects","url":"/docs/intro#have-questions","content":" If you have questions about my projects or wish to discuss potential opportunities, feel free to reach out at dario@dariocruz.dev. ","version":"Next","tagName":"h2"},{"title":"Qualys Cloud Agent vs Scanner Appliance","type":0,"sectionRef":"#","url":"/docs/Qualys Vulnerability Management/Qualys Cloud Agent vs Scanner Appliance","content":"","keywords":"Qualys Vulnerability Scanning Scanner Appliance Cloud Agent Vulnerability Management","version":"Next"},{"title":"Comparing Vulnerability Reportsâ€‹","type":1,"pageTitle":"Qualys Cloud Agent vs Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Cloud Agent vs Scanner Appliance#comparing-vulnerability-reports","content":" From the previous entries in this project, we should remember that the scanner appliance only found 5 vulnerabilities, 3 of which are confirmed vulnerabilities 2 potential. Most of the vulnerabilities found where related to configurations of operating system services.  Now, looking at the Qualys cloud agent scan, we can see that this scan in particular found many more vulnerabilities on the same system, 264 in total.The cloud agent as you can see provides more in depth scanning and detail in regards to the vulnerabilities that where found but, why is this?  ","version":"Next","tagName":"h2"},{"title":"Scanning from Two Different Vantage Pointsâ€‹","type":1,"pageTitle":"Qualys Cloud Agent vs Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Cloud Agent vs Scanner Appliance#scanning-from-two-different-vantage-points","content":" The Qualys scanner appliance and the cloud agent provide scanning from different vantage points and ways of implementing scanning. The Qualys scanner appliance resides on the network, external to the target machine(s). The advantage it has is the ability to scan multiple targets and do so either on demand or on a schedule. All and administrator needs to do is ingest the machines into the Qualys platform and provide admin credentials. Once the scanner appliance is on the network it will start reporting on it's findings, without the need to install software on the endpoint.  Qualys cloud agent runs it's scans while residing on the endpoint, running as an elevated service. Since it resides on the endpoint machine, it has the ability and the access to complete deeper more detailed scans of the target endpoint, analyzing applications installed/running, system configurations, and more. One advantage to note with cloud agents is that they are not dependent on the endpoint being on the corporate network. It's common now in enterprise environments to have sets of users that work remote but, still need to be monitored for compliance and vulnerabilities, Qualys cloud agents facilitate this functionality. ","version":"Next","tagName":"h2"},{"title":"Vulnerability Remediation","type":0,"sectionRef":"#","url":"/docs/Qualys Vulnerability Management/Remediation","content":"","keywords":"Qualys Vulnerability Management Remediation Vulnerability Management CVE","version":"Next"},{"title":"Removing Outdated Appsâ€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#removing-outdated-apps","content":" Digging into the results of the cloud agent scan, we can see that the majority of the severity 5 vulnerabilities are coming from the outdated version of Firefox that we installed on our Windows 10 VM. In order to remediate these issues with outdated apps we either need to update them or flat out uninstall them, which is the course of action that I am going to take.    Previously we took some snapshots of the Windows 10 VM, which is great as if we further need to test out Qualys scanning, we can always revert the machine back to it's vulnerable state and continue testing.  Then, by logging into our Windows 10 VM and checking the installed apps, we can confirm that Firefox 18.0.1 is installed. I proceeded to remove Firefox and all the other old apps that we installed for the purposes of this lab.    To recap the list of vulnerable software that was installed on the machine, that has now been removed is as follows:  VLC Media Player 0.9.8Mozilla Firefox 18.0.1Google Chrome 24.0.1312.57VirtualBox 4.2.18PuTTY 0.59  Now that they are uninstalled, let's push an on-demand scan task to the cloud agent. From the Qualys cloud agent section of the dashboard, we click on the entry for our Windows VM, and from the drop down we select On Demand Scan.    Select the type of scan that is to be run, in our case for this project, I have selected the option for Vulnerability Scan.    After the cloud agent finished the on demand scan, I checked for reported vulnerabilities on the machine. We no longer have any severity 5 issues related to any of the applications that we purposely installed, we also now only have 6 active vulnerabilities being reported with, 267 vulnerabilities fixed. Lets continue on an see what we have left to remediate.    Looking now at the remaining vulnerabilities, let's tackle them by severity, which is how security professionals in the real would would prioritize and address these issues. We have one severity 4 vulnerability. Checking the details it shows the following:      ","version":"Next","tagName":"h2"},{"title":"WinVerify Trust Signature Validationâ€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#winverify-trust-signature-validation","content":" Okay, so we have a vulnerability relate to Microsoft WinVerify Trust Signature Validation. Clicking on the details of the vulnerability, Qualys provides useful information about the vulnerability. The details include the CVE ID of the vulnerability, if there is a patch available for it, compliance related info, and detection logic for how the cloud agent scans for and confirms the vulnerability.    It looks like our cloud agent checks for the presence of two regkeys HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Cryptography\\Wintrust\\Config and also HKEY_LOCAL_MACHINE\\Wow6432Node\\Software\\Microsoft\\Cryptography\\Wintrust\\Config.  Digging into the CVE information via the link provided in the details, it looks like this vulnerability was a republication of another CVE for the same issue. Microsoft republished the CVE as it does not plan to enforce the stricter method of signature verification EnableCertPaddingCheck on it's current versions of Windows 10 &amp; 11.  The vulnerability itself is a flaw that is present in the way in which the Windows OS function, WinVerify Trust, handles Authenticode signature validation. This is done for (PE) Portable Executable files. The flaw allows for threat actors to pad an already verified PE file, enabling malicious code to execute, allowing the possibility of complete take over of the target system. This is all done without invalidating the file's trust signature. The attack vectors for this type of vulnerability are numerous due to the fact that all you have to do is have an unsuspecting user execute the file.  ","version":"Next","tagName":"h2"},{"title":"Remediationâ€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#remediation","content":" So, now we know what this vulnerability is, it's scope of impact on our VM, which is significant, lets us now look to remediate this vulnerability. Qualys has a tab on the vulnerability report for solutions to reported vulnerabilities.    The information in the solution tab gives us much of the same information present on the URL provided for the CVE. The link in the solutions page though, points to Microsoft's official information for the vulnerability. Scrolling down to toward the bottom of that page, we can see steps for remediation.  We have to go into the Windows registry and modify two registry key entries, which are the two I mentioned from the detection logic that Qualys was using to detect the vulnerability in the first place.  Launching back into our Windows VM. I opened up Regedit as admin and proceeded to make the needed changes to the two registry keys. The first of which was HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Cryptography\\Wintrust\\Config. When I navigated to the path I did not find a registry key, so I went ahead and created it and added the DWORD EnableCertPaddingCheck, giving it a value of 1.      I then did the same for HKEY_LOCAL_MACHINE\\Wow6432Node\\Software\\Microsoft\\Cryptography\\Wintrust\\Config and rebooted the machine, as the Microsoft documentation states.    I then initiated an on demand scan of the VM from the Qualys dashboard. It has updated and now the vulnerability is no longer present on the machine. Vulnerability remediated!    ","version":"Next","tagName":"h3"},{"title":"Allowed Null Sessionsâ€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#allowed-null-sessions","content":" Moving down the list of vulnerabilities present The next item on the list is a Sev 3 vulnerability about having Windows configured to Allow Null Sessions. The vulnerability is related to two CVEs, namely CVE-2002-1117 and CVE-2000-1200. The first CVE, CVE-2002-1117, details that the software Veritas Backup Exec requires that Microsoft Exchange 2000 servers are required to have the regkey RestrictAnonymous set to a value of 0 for it to function correctly, leaving the target server vulnerable. CVE-2000-1200 details that with Null sessions allowed, on domain joined windows computers, a threat actor could enumerate all users currently on the domain. This is done via obtaining of the domains SID via the use of the LsaQueryInformationPolicy function when in the null session.  ","version":"Next","tagName":"h2"},{"title":"Remediationâ€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#remediation-1","content":" Now that we have educated ourselves on the vulnerability and what impact in can have on an organizations environment, we need to remediate it. The CVE listings presented by Qualys provided useful information but, not a way to resolve the issue.  Qualys as a platform does provide a solution tab to explore that should point us in the correct direction for remediation.    The above is the solution tab for the vulnerability we are looking to remediate. We are pointed to two documentation pages from Microsoft on the RestrictNullSessAccess and RestrictAnonymous settings.  Clicking on the link for the RestrictNullSessAccess and reading through the documentation, we can see that we have to go into the Windows registry and add the key RestrictNullSessAccess to HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters and setting it to a value of 1.  The second link for RestrictAnonymous explains the best practice of not allowing anonymous SAM accounts and shares, also the related group policy to enable/disable this setting. The Qualys vulnerability details also explain that scanners look for the presence of the registry key HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\LSA RestrictAnonymous, which controls this setting. If it is not their then the system is vulnerable.  Proceeding on with this information I proceeded to push the configuration changes to our virtual machine for remediation.  I proceeded to open regedit as admin and navigate to the first registry entry HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Paraemters. As you can see we have the needed option/regkey present, which is RestrictNullSessAccess but, the value is set to 0.    At Qualys' recommendation I will enable the restriction by changing the regkey value to 1, restricting null session access on the machine.    Moving ahead to the second regkey we need to change, HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\LSA, I confirmed that on the machine the needed option/regkey, RestrictAnomymous was present but, had a value of 0. I enabled the setting, changing the regkey value to 1.    After the changes to the registry keys were complete, I went ahead and initiated an on-demand scan of the machine via the Qualys dashboard and waited for it to complete. After about an hour, I checked the status of the VM in Qualys and found that the vulnerability was remediated and no longer detected by Qualys.      ","version":"Next","tagName":"h3"},{"title":"SMB Signing Disabledâ€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#smb-signing-disabled","content":" Moving on to the next vulnerability found, we have an entry for SMB signing being disabled.  Using the same methodology that we have used in previous remediations, I checked Qualys details of the vulnerability and the recommended method for remediation.        SMB signing is a function that provides and extra layer of security for SMB share access, thwarting man-in-the-middle attacks. It works via digitally signing SMB packets, leveraging Kerberos and NTLM in the process.  Reading through the Microsoft Documentation Qualys recommended, I found that we need to change the following group policy settings;  Computer Configurations &gt; Windows Settings &gt; Security Settings &gt; Local Policies &gt; Security Options in here there are two settings. Microsoft network client: Digitally Sign Comminications (always) | Set to Enabled.Computer Configurations &gt; Windows Settings &gt; Security Settings &gt; Local Policies &gt; Security Options in here there are two settings. Microsoft network server: Digitally Sign Comminications (always) | Set to Enabled.    Now that we have the needed information to remediate the vulnerability, we can go ahead and enable the necessary group policy settings. I did this, following this up with a push of an on-demand vulnerability scan on the target VM.    And as you can see from the above, we can confirm that the vulnerability has been remediated. We no longer have a Sev 3 vulnerability related to SMB signing.    ","version":"Next","tagName":"h2"},{"title":"Birthday Attacks Against TLS (Sweet32)â€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#birthday-attacks-against-tls-sweet32","content":" This is our last confirmed vulnerability found on the our vulnerable virtual machine. The vulnerability affects TLS and is due in part to the configuration of ciphers used for the protocol. We have to re-configure Windows to make use of more modern secure ciphers. Lets take a look at the threat details to gather some insights.    Okay so, legacy block ciphers that use a blocks of 64 bits are vulnerable, this includes DES, 3DES, IDEA, and RC2. The way Qualys checks and confirms the vulnerability is via checking the presence of HKLM\\SOFTWARE\\Policies\\Microsoft\\Cryptography\\Configuration\\SSL\\00010002 and checking it's value.  The solution section provides some documentation on the Sweet32 attack, Windows TLS changes, and Microsoft TLS Registry settings. Focusing on the Windows TLS changes page and ready through the content, we need to remove the entry for DES/3DES from the cipher suite functions registry key located at, HKLM\\SOFTWARE\\Policies\\Microsoft\\Cryptography\\Configuration\\SSL\\00010002, which will disable usage of this old cryptography method.  Here we are at the registry location looking at the values of the function key. We can see that 3DES is in the list, specifically TLS_RDA_WITH_3DES_EDE_CBC_SHA. 3DES was on the list of encryption standards that were included in the vulnerability details. Lets go ahead and remove that entry to disable the usage of that cipher suite.    I then rebooted the Windows VM and initiated an on-demand scan from the Qualys dashboard. After the scan was run, the Qualys dashboard confirmed that the vulnerability was remediated. We no longer have a Sev 4 entry for Birthday Attacks (Sweet32).      ","version":"Next","tagName":"h2"},{"title":"Curl Exposure CVE-2025-0167â€‹","type":1,"pageTitle":"Vulnerability Remediation","url":"/docs/Qualys Vulnerability Management/Remediation#curl-exposure-cve-2025-0167","content":" At the time of this projects writing, there was discovered and vulnerability affecting a subset of version of the curl cli tool. During investigation of this CVE, I found that there was no clear way to mitigate the vulnerability directly on Windows. Curl is a integral part of the Windows OS so remediation guidance has to be provided by Microsoft, either in the form of a system update or possibly some registry or group policy settings.      In the case that the CVE details are updated to include remediation steps or an update is issued by Microsoft, I will update this project with steps taken for remediation. ","version":"Next","tagName":"h2"},{"title":"Qualys Vulnerability Management: Introduction","type":0,"sectionRef":"#","url":"/docs/Qualys Vulnerability Management/Introduction","content":"","keywords":"Qualys vulnerability management scanning compliance cybersecurity","version":"Next"},{"title":"Why Qualys?â€‹","type":1,"pageTitle":"Qualys Vulnerability Management: Introduction","url":"/docs/Qualys Vulnerability Management/Introduction#why-qualys","content":" Qualys is a SaaS/cloud-based vulnerability management platform that was founded in 1999. Since 1999, they have become the leading provider of info sec and compliance cloud solutions. Organizations use Qualys for scanning, discovery, and prioritization of vulnerabilities found on their endpoints and servers but, Qualys as a company offers many more options to their customers than just that. 1  ","version":"Next","tagName":"h2"},{"title":"How does it workâ€‹","type":1,"pageTitle":"Qualys Vulnerability Management: Introduction","url":"/docs/Qualys Vulnerability Management/Introduction#how-does-it-work","content":" Qualys is a SaaS so the platform runs on the cloud. Enterprises subscribe to the service and that service will then scan and report on any device that is added to the organizations implementation. This is done via installing what are called software agents on endpoints to be scanned or installing a scanner appliance, which scans the hosts without the need to install any software on the endpoints. The software agents carry out the task of scanning the endpoint and reporting telemetry back to Qualys cloud servers as do the scanner appliances. Qualys as a platform provides a dashboard for viewing all endpoints and the results of their scans. The platform will also alert on vulnerabilities found, based on the organizations settings and implementation.  ","version":"Next","tagName":"h3"},{"title":"Qualys Community Editionâ€‹","type":1,"pageTitle":"Qualys Vulnerability Management: Introduction","url":"/docs/Qualys Vulnerability Management/Introduction#qualys-community-edition","content":" Lucky for us cyber security learners, Qualys the company provides a handy community edition of their platform and software. This gives us and anyone else that would like to learn about to tool/platform access to make an account, install agent software on endpoints and see results.  ","version":"Next","tagName":"h2"},{"title":"Creating a Qualys Accountâ€‹","type":1,"pageTitle":"Qualys Vulnerability Management: Introduction","url":"/docs/Qualys Vulnerability Management/Introduction#creating-a-qualys-account","content":" First things first, we need to create an account to access the Qualys platform. A quick google search brought up the direct URL to make an community edition account, https://qualys.com/community-edition.  Just fill out the information and you should receive and email in your inbox to confirm the creation of the account.    At this point I had a bit of a wait before my account information was emails to me, so I took the time to checkout the &quot;Getting Started&quot; guide which can be found here. The PDF offers a good amount of documentation on how to ingest endpoints and even entire domains into the platform, allowing for configuration of scanning and alerting.  After you receive your initial login credentials and sign in to Qualys, youâ€™ll be presented with the main dashboard along with initial setup steps for configuring scanning in your environment.    In my lab implementation, I began by setting up a vulnerable Windows 10 VM to test scanning using both a Qualys scanner appliance and a Qualys cloud agent. Turn to the next page for a step-by-step guide on how I built this Windows test environment for vulnerability scanning.    Footnotesâ€‹ Qualys - About â†© ","version":"Next","tagName":"h3"},{"title":"Configuring Vulnerable Windows 10 VM","type":0,"sectionRef":"#","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10","content":"","keywords":"Homelab Cyber Qualys Windows Proxmox Vulnerable Configuration","version":"Next"},{"title":"Windows 10â€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#windows-10","content":" So the idea is to make a vulnerable Windows 10 VM. How can we make it vulnerable you might say? Well for that we have some options:  Disable Windows Update &amp; uninstall pre-installed system updates.Disable Windows Firewall and Microsoft Defender.Use PowerShell scripts to set vulnerable configurations. (Found this resource: Windows 10 Misconfigured Services Lab)  Now that we have a set of methods that we can use to make a Windows 10 VM vulnerable and insecure, lets get on with the setup. For my labbing purposes I am using Proxmox, so I will be creating my VM using that. If you haven't seen my post on building out my home lab you can see it here  ","version":"Next","tagName":"h2"},{"title":"Obtaining Windows 10 ISOâ€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#obtaining-windows-10-iso","content":" I've seen a lot of people go and download the Windows 10 ISO using the Microsoft provided media creation tool. While this is a viable option, I will be going to the Microsoft Evaluation Center which hosts all enterprise Windows 10/11 and Windows Server images.After a few clicks of navigating through the website to the Windows 10 Enterprise page, we are presented with the option of directly downloading the ISO file, after providing Microsoft with some information.  ","version":"Next","tagName":"h3"},{"title":"Proxmox VM setupâ€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#proxmox-vm-setup","content":" Now that we have the image we need to uploaded to one of our Proxmox nodes. I have chosen my lab01 node for this as it's not running anything critical to any other projects at the moment.  Here is the upload to the node in progress.  And here I am creating the VM in Proxmox, naming the VM Vulnerable-WIN10.  After uploading of the image I started to configure the Windows VM with the following settings:  Element\tValueSystem\tSeaBIOS with LVM-Thin TPM Storage Storage\t100 gigabytes (LVM-Thin) CPU\t1 Socket - 2 Cores Memory\t4 gigabytes Network\tDefault Settings (Have PFSense Firewall managing DHCP, etc.)  Selecting the ISO image and configuring Proxmox to expect a Windows-based OS.  Configuring Proxmox BIOS(SeaBIOS), TPM(Stored on LVM-Thin storage), and QEMU settings.  VM Startup and installing Windows 10.  And here we are at the desktop.  ","version":"Next","tagName":"h3"},{"title":"Making it Vulnerableâ€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#making-it-vulnerable","content":" Now that we have our Windows 10 VM lets make it vulnerable and insecure. To do that First thing I am going to do though is to create a snapshot of the VM. Why, you ask? Well if I take a snapshot now, I can revert any changes that we make to the system bringing it back to a baseline that we can use for other projects or to compare results in Qualys. We can take a snapshot from the Proxmox web interface, under the VM options.  We then confirm the name of the snapshot and provide a description that we can use as reference later.  ","version":"Next","tagName":"h2"},{"title":"Windows Updatesâ€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#windows-updates","content":" Okay so on to Windows configuration. We first need to disable automatic updates in Windows. To do so, we navigate to Settings &gt; Windows Updates and pause updates for 7 days.  While this option will work, I wanted something more permanent then just 7 days of no updates so I searched the web and found this script.  # Stop the Windows Update service Stop-Service wuauserv # Disable the Windows Update service Set-Service wuauserv -StartupType Disabled # Disable Automatic Updates via Registry Set-ItemProperty -Path &quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU&quot; -Name &quot;NoAutoUpdate&quot; -Value 1 -Type DWord   Here I am pasting the code into notepad and saving it as a .ps1 file.  I opened and admin privileged powershell terminal proceeded to navigate to and execute the PowerShell script, because the script is not signed we have to set PowerShell's execution policy to unrestricted we can do this via Set-ExecutionPolicy unrestricted, then hit a to say yes to all prompts for the change.The script did have an error though but, after investigating I saw that the registry path that the script was attempting to modify, didn't exist on this version of Windows 10. I did however, check Windows services and verified that the Windows Update service was set to disabled and to not startup which is the majority of what the script was intended to do.  Last thing to do in regard to Windows Updates is to uninstall any updates that came preinstalled upon Windows setup. We need to go back into the Windows Update settings and navigate to View Update History &gt; Uninstall Updates and remove whatever updates that you can.Note: With the version of Windows that I installed 22H2, I was only able to uninstall the top most update KB5026037, the rest of the updates had the option to uninstall greyed out.  ","version":"Next","tagName":"h3"},{"title":"Windows Firewallâ€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#windows-firewall","content":" Next on the list is disabling of Windows Firewall. Navigate to Start &gt; Run &gt; wf.msc and the firewall settings should appear. Click on Windows Firewall Properties, set the firewall to off, and hit apply/okay.And with that, we are finished with Windows Firewall.  ","version":"Next","tagName":"h3"},{"title":"Microsoft Defenderâ€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#microsoft-defender","content":" Next on the list is to disable Microsoft Defender, which is Microsoft's built-in Anti-Virus/Malware tool that continuously scans the OS environment for malicious files and for suspicious activity. It will also automatically take actions to remediate any found issues.  The steps to disable Microsoft Authenticator are fairly straight forward. Lets open up the Windows Run dialogue, which can be opened via the Win+R short cut or via right-clicking of the start button and clicking Run.  From there we will open the Group Policy editor via entering in gpedit.msc and hitting enter.  Group Policy editor should load up. The entry that we are looking for is called, Turn Off Microsoft Defender Antivirus and it can be found under Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Microsoft Defender Antivirus.  Double-clicking this entry will bring up the option to enable this policy, which in turn disables Microsoft Defender permanently on our Windows 10 VM. Enable the policy, and hit apply for the changes to take effect.  ","version":"Next","tagName":"h3"},{"title":"Installing Old Appsâ€‹","type":1,"pageTitle":"Configuring Vulnerable Windows 10 VM","url":"/docs/Qualys Vulnerability Management/Vulnerabile Windows 10#installing-old-apps","content":" Last thing on the list, installing old outdated and vulnerable software. For this task I am making use of https://oldversion.com/. They have a repository of many old software versions of popular software.  Here is a list of what I am installing to test out Qualys vulnerability scanning:  VLC Media Player 0.9.8Mozilla Firefox 18.0.1Google Chrome 24.0.1312.57VirtualBox 4.2.18PuTTY 0.59  After installing all the old software, I also took another snapshot of the VM so that I could revert back to this state if needed. ","version":"Next","tagName":"h3"},{"title":"Qualys Network Discovery","type":0,"sectionRef":"#","url":"/docs/Qualys Vulnerability Management/Qualys Network Discovery","content":"","keywords":"Qualys Network Discovery Network Scanning Network Discovery Vulnerability Management","version":"Next"},{"title":"Setup up a Discovery Scanâ€‹","type":1,"pageTitle":"Qualys Network Discovery","url":"/docs/Qualys Vulnerability Management/Qualys Network Discovery#setup-up-a-discovery-scan","content":" To start scanning and discovering elements of our network, from the Qualys dashboard we go to Scans and then click Maps from there we configure our discover scan.  From the menu windows that pops up I configured all of the information needed. I gave my network discovery scan a name First Discovery Scan, chose the Qualys Recommended Option for our scan settings, set the scope to the range of IP addresses for my home lab network 10.1.1.1-10.1.1.25, I then launched the scan.  After launching the network discovery scan we are placed back at the Qualys scan dashboard and now have an entry for the created scan, now we wait for the discovery scan to be completed by our scanner appliance and report on it's findings.  ","version":"Next","tagName":"h2"},{"title":"Analyzing Resultsâ€‹","type":1,"pageTitle":"Qualys Network Discovery","url":"/docs/Qualys Vulnerability Management/Qualys Network Discovery#analyzing-results","content":" In my instance the network discovery scan took about 10 minutes. When the scan is finished the status will update and show you a small summary of what was found. Looking at the image below you can see that 7 hosts in total where found as a result.  On the right side of the Qualys web interface, after clicking on the scan task, there is an set of actions to choose from, we can view the report of findings in two ways, graphical, or just as a normal report. There are also options for relaunching the scan and downloading the report of results. Lets first look at the report and see what the scanner appliance was able to find.  Here we are at the full report of findings for our network discovery scan. We have a list of the settings for the scan. The time and date that the scan was completed, the settings and scope of the scan, and a list of IP addresses found with NETBIOS information.I can see in the list the hostname LAB-DC01, which is my Windows Server 2019 VM that has Active Directory domain services running on it for a separate project. I can also see the hostname for our vulnerable Windows 10 machine, DESKTOP-EBP61JD. Lastly, there is a host with the NETBIOS name of FILESERVER, which is a Turnkey Linux container that is hosting an SMB share. I spin up this container when I need to transfer files between VM's my home lab network.  Clicking on the drop down tabs to the left of the found IP addresses, reveals what ports were found open on the host. Looking at my domain controller I can see that TCP ports 53, 80, 135, 139, &amp; 445 are open as well as UDP ports 53 &amp; 137.Ports 137, 138, 139, and 445 are all used for SMB. SMB is used by Active Directory for group policy setting distribution through out a domain via the SYSVOL hidden share. They are also used for any smb network shares that are configured for the domain as well.  Our vulnerable Windows 10 machine also has a similar set of ports open for the smb protocol but also, has the addition of TCP port 135. This port is used for the RPC Endpoint Mapper service, which is a Windows service that allows other systems on a given network, to discover what services are advertised by a host, and what port to find them on. 2  Moving on to the Turnkey fileserver. We also see similar ports with the addition of TCP ports 21, 22, 111 and UDP port 111. Ports 20/21 are both used for the FTP Protocol, Ports 111 UPD and TCP are used for the RPC portmapper service, allowing for discover of ports for RPC services. 3  The remaining IP addresses 10.1.1.11, 10.1.1.12, and 10.1.1.13 are the Proxmox nodes for the home lab. All 3 nodes reported the same ports open TCP ports 21, 111 and UDP 111, both of which we have already spoke about. IP address 10.1.1.23 is a Kali Linux VM that I am using for Hack The Box academy modules and sherlock investigations. The host does not report any ports being open.  ","version":"Next","tagName":"h2"},{"title":"Graphical Viewâ€‹","type":1,"pageTitle":"Qualys Network Discovery","url":"/docs/Qualys Vulnerability Management/Qualys Network Discovery#graphical-view","content":" The second option for viewing results of network discovery scans is via the graphical view. To open it we navigate to our finished scan &gt; actions &gt; view graphical mode.  The graphical view itself is very straight forward. Depending on the network topology, the graphical view will show a map of the given network that the scanner appliance is running on. In our case my home lab network is fairly simple. Clicking on a item in the graphical view will display much of the same information as with the regular report.All of the hosts discovered on my home lab network are being labelled as rogue, due to the fact that I have not ingested them into Qualys' asset management function.    Footnotesâ€‹ Qualys Network Discover Documentation â†© Assessing Windows Networking Services â†© CBT Nuggets Port 111 â†© ","version":"Next","tagName":"h3"},{"title":"Deploying Qualys Scanner Appliance","type":0,"sectionRef":"#","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance","content":"","keywords":"Qualys Proxmox VM Virtualization Vulnerability Scanning","version":"Next"},{"title":"Implementing Qualys Scanner in Proxmoxâ€‹","type":1,"pageTitle":"Deploying Qualys Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance#implementing-qualys-scanner-in-proxmox","content":" The images file for Proxmox is a .qcow file type, which is a QEMU image file. The image file is inside of a tar.gz archive so it will need to be extracted before use. The Qualys website has some documentation on how to deploy the image to a Proxmox implementation, this can be found here.  Following the steps in the documentation, I extracted the image file out of the archive and proceeded to transfer the file via SCP protocol to my Proxmox node lab01 which will be hosting the VM for the scanner appliance. All of this can be done via admin enabled PowerShell.  Now back at the Proxmox web interface, I made a VM and noted down the VM ID, as stated in the documentation.  ","version":"Next","tagName":"h2"},{"title":"Importing the Qcow2 Imageâ€‹","type":1,"pageTitle":"Deploying Qualys Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance#importing-the-qcow2-image","content":" Okay so here is where I deviated from the Qualys documentation. I attempted to add the image to the VM with the settings I applied but, I was using primarily LVM &amp; LVM-Thin storage for my VMs so far. What I needed to do to import the file was to create Directory type storage. You see, Proxmox VMs and Containers can be provided storage at file-level or at the block-level. LVM &amp; LVM-Thin are block-level storage solutions thus, the need to make the change over to file-level storage.  Storage Issuesâ€‹  More issues arose as I attempted to create the directory storage we needed. On my Proxmox nodes I formatted my VM storage disks as LVM-Thin and had them use all the storage that the physical drive had, leaving no run for any other storage types to be made. ðŸ˜”  To get around this issue I decided to format the SSD installed on node lab03 the node itself was just running a single ParrotOS VM, which I was using as an access VM to configure PFsense during the initial setup of the lab.  Here I am deleting the VM.  Here we are deleting the LVM-Thin storage.  We also need to wipe the physical drive to prep it for new storage pool creation as well.  Now lets create the Directory storage.  With that created I proceeded to recreate the VM with the settings in the Qualys documentation.  With the VM created I needed to transfer the .Qcow2 image downloaded from Qualys from node lab01 to node lab03 where our VM resides. I ssh'ed into lab01 and used SCP to transfer the image file over. I then deleted the file from lab01 just to keep things nice and tidy.  Reading the documentation, we then have to copy the image file to the images folder of the VM we created, in my case I did not have a folder for my VMID, which is 102 so I created it and copied the image file there.  Looks like making the directory worked, after checking the web interface I can see that now for the hard disk, it points to the file that we moved to the images folder.  And unfortunately this did not completely solve all of the issues. Starting up the VM, I was met with boot looping from PXE boot to the BIOS screen, meaning that the image was not being read and the OS was not being detected and booted into.  Found a command after doing some research that storage paths and settings were stored in /etc/pve/storage.cfg I used cat to spit the contents of the file into the terminal. I found the path to the directory storage we created and found the VM image there.  I proceeded to move the file that we placed in /var/lib/vz/102/images to the proper location at /mnt/pve/vm-dir-storage/images/102 overwriting the image that was already there.  And now it boots.ðŸš€ðŸš€ðŸš€  ","version":"Next","tagName":"h3"},{"title":"Configuring Qualys Scanner Applianceâ€‹","type":1,"pageTitle":"Deploying Qualys Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance#configuring-qualys-scanner-appliance","content":" Once the VM is fully booted I was met with this screen asking to proceed to &quot;Personalization&quot; settings.  Hitting enter on this screen took me to configuration settings for the scanner. First thing to do was to input a &quot;Personalization Code&quot;. This code can be found one the Qualys dashboard under Appliances.  The Qualys Scanner software then goes through a configuration and update process.  After the process finishes we are brought back to the configuration page. In my case the Qualys Scanner software negotiated an IP address from the PFsense DHCP service, for now this is okay for our needs. For extended testing though, it should be paramount to configure a static IP.  Back at the Qualys dashboard, we can now see that our scanner appliance is successfully communicating back to Qualys's servers.  We now have an active scanner appliance on our isolated home lab network. We can now configure Qualys to scan specific IP addresses of hosts/endpoints on our network and scan for vulnerabilities.  ","version":"Next","tagName":"h3"},{"title":"Vulnerability Scanning with Scanner Applianceâ€‹","type":1,"pageTitle":"Deploying Qualys Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance#vulnerability-scanning-with-scanner-appliance","content":" Now it is time to actually scan our vulnerable machine using our newly configured scanner appliance. In order to get the scan to work properly we will need to provided credentials so that the scanner appliance can login and complete scan tasks and provide reports on vulnerabilities found.  To do this we navigate back to the Qualys dashboard &gt; Vulnerability Management &gt; Authentication. In Qualys scanner appliance scans can be completed with authentication or without, without authentication is called an unprivileged scan. When authentication credentials are provided, specifically admin accounts, the scanner will have privileges to complete deeper scans of the target host.  ","version":"Next","tagName":"h2"},{"title":"Authentication Credentialsâ€‹","type":1,"pageTitle":"Deploying Qualys Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance#authentication-credentials","content":" At the authentication page we need to add a new set of credentials, this can be done via the New dropdown menu. In or case we will select Operating System &gt; Windows and proceed on to the next step.  In the new browser window that appears we have a few options to configure, first of which is to give our set of credentials a name, I've named mine Vulnerable-Windows10.  Next will be the login credentials. Note that by default the credential settings will be set to domain. For my use cause, and since I have not setup and joined our vulnerable Windows 10 machine to a domain, I will be using the local authentication method and leaving the settings to their defaults.  Providing the login credentials to the machine, I moved on to the next setting which was IP address information. My machine currently has the IP address of 10.1.1.18. Added the IP address and then added some comments to clarify what the credentials are for, I then saved the information.  And now we have a set of credentials for our machine defined in Qualys.  ","version":"Next","tagName":"h3"},{"title":"Initiating Scanner Appliance Scanâ€‹","type":1,"pageTitle":"Deploying Qualys Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance#initiating-scanner-appliance-scan","content":" It's finally time to actually scan our Windows machine with our scanner appliance, to do so navigate to Vulnerability Management &gt; Scan from here we click New &gt; Scan and proceed on to the pop-up browser window and configured the scan.  In the window that popped up we have a set of scan settings. I filled out all of the options, using all of the items that we have configured so far, our scanner appliance, IP of our Windows machine, scan priority and the type of scan to be run. In this instance I will use the &quot;Qualys Recommended Option&quot;, just to see what information in provides after the scan.  I initiated the scan and gave it some time run through it's process. Going back to the Qualys dashboard and looking at the scan section, we can now see that our scan is in the queue to be completed by the Scanner Appliance.  Note that when the scanner appliance is actually running the scan, the status of the scan will change to &quot;Running&quot; and also clicking on the scan entry, will bring up more status information regarding how far the scan has progressed.  Once the scan is finished a report will be generated and emailed to the address on the account profile. Going back to scans and clicking on the report, we are presented with a report of Qualys' findings.  ","version":"Next","tagName":"h3"},{"title":"Breaking Down the Resultsâ€‹","type":1,"pageTitle":"Deploying Qualys Scanner Appliance","url":"/docs/Qualys Vulnerability Management/Qualys Scanner Appliance#breaking-down-the-results","content":" Looking at the findings we can see that a total of 28 vulnerabilities where found by the scanner appliance. Vulnerabilities are broken down into severity levels which allow for prioritization of the most critical findings. We can also see that found vulnerabilities are categorized.  Scrolling down to the report we are provided with more detailed information about the vulnerabilities found.  We have 3 vulnerabilities that are confirmed, SMBv2 issue with signing not being required on the Windows OS, NetBIOS name being accessible, and a vulnerability about the default Windows Admin account name being present.  There is also a list of potential vulnerabilities that have been found, the windows Guest account not being renamed and an issue pertaining to the Global User list. As well as some information gathering entries. Later on in this project we will compare and contrast scanning with a Qualys scanner appliance vs installing a Qualys Cloud Agent on the same vulnerable machine. For now lets move on to setup and installation of said cloud agent. ","version":"Next","tagName":"h3"}],"options":{"id":"default"}}