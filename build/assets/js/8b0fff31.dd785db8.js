"use strict";(self.webpackChunkdariocruz_dev=self.webpackChunkdariocruz_dev||[]).push([[3623],{3646:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>r,contentTitle:()=>n,default:()=>l,frontMatter:()=>i,metadata:()=>h,toc:()=>c});var a=s(4848),o=s(8453);const i={slug:"Reaper-HTB-Sherlocks",title:"Reaper(HTB-Sherlocks)",authors:["dcruz"],tags:["Labs","Hackthebox","Incident-Response","Incident-Investigation","NTLM","NetBios","Pass-The-Hash"]},n=void 0,h={permalink:"/blog/Reaper-HTB-Sherlocks",source:"@site/blog/2024-08-23-Reaper-Sherlock/index.mdx",title:"Reaper(HTB-Sherlocks)",description:"Reaper-HTB-Sherlock",date:"2024-08-23T00:00:00.000Z",tags:[{inline:!0,label:"Labs",permalink:"/blog/tags/labs"},{inline:!0,label:"Hackthebox",permalink:"/blog/tags/hackthebox"},{inline:!0,label:"Incident-Response",permalink:"/blog/tags/incident-response"},{inline:!0,label:"Incident-Investigation",permalink:"/blog/tags/incident-investigation"},{inline:!0,label:"NTLM",permalink:"/blog/tags/ntlm"},{inline:!0,label:"NetBios",permalink:"/blog/tags/net-bios"},{inline:!0,label:"Pass-The-Hash",permalink:"/blog/tags/pass-the-hash"}],readingTime:7.955,hasTruncateMarker:!0,authors:[{name:"Dario Cruz",title:"Maintainer of DarioCruz.dev",url:"https://github.com/dario-cruz",imageURL:"https://github.com/dario-cruz.png",key:"dcruz",page:null}],frontMatter:{slug:"Reaper-HTB-Sherlocks",title:"Reaper(HTB-Sherlocks)",authors:["dcruz"],tags:["Labs","Hackthebox","Incident-Response","Incident-Investigation","NTLM","NetBios","Pass-The-Hash"]},unlisted:!1,prevItem:{title:"Security+ Passed!",permalink:"/blog/Security-Plus-Passed"},nextItem:{title:"The Journey So Far",permalink:"/blog/The Journey So Far"}},r={authorsImageUrls:[void 0]},c=[{value:"Lets get Labbing",id:"lets-get-labbing",level:2},{value:"Reaper",id:"reaper",level:2},{value:"Task 1: What is the IP Address for Forela-Wkstn001?",id:"task-1-what-is-the-ip-address-for-forela-wkstn001",level:2},{value:"What is NetBios?",id:"what-is-netbios",level:3},{value:"Task 2: What is the IP Address for Forela-Wkstn002?",id:"task-2-what-is-the-ip-address-for-forela-wkstn002",level:2},{value:"Task 3: Which user account&#39;s hash was stolen by attacker?",id:"task-3-which-user-accounts-hash-was-stolen-by-attacker",level:2},{value:"What is NTLM",id:"what-is-ntlm",level:3},{value:"Task 4: What is the IP Address of Unknown Device used by the attacker to intercept credentials?",id:"task-4-what-is-the-ip-address-of-unknown-device-used-by-the-attacker-to-intercept-credentials",level:2},{value:"Task 5: What was the fileshare navigated by the victim user account?",id:"task-5-what-was-the-fileshare-navigated-by-the-victim-user-account",level:2},{value:"Task 6: What is the source port used to logon to target workstation using the compromised account?",id:"task-6-what-is-the-source-port-used-to-logon-to-target-workstation-using-the-compromised-account",level:2},{value:"Task 7: What is the Logon ID for the malicious session?",id:"task-7-what-is-the-logon-id-for-the-malicious-session",level:2},{value:"Task 8: What is the workstation name and the source IP Address from which the malicious logon occur?",id:"task-8-what-is-the-workstation-name-and-the-source-ip-address-from-which-the-malicious-logon-occur",level:2},{value:"Task 9: When did the malicious logon happened. Please make sure the timestamp is in UTC?",id:"task-9-when-did-the-malicious-logon-happened-please-make-sure-the-timestamp-is-in-utc",level:2},{value:"Task 10: What is the share Name accessed as part of the authentication process by the malicious tool used by the attacker?",id:"task-10-what-is-the-share-name-accessed-as-part-of-the-authentication-process-by-the-malicious-tool-used-by-the-attacker",level:2},{value:"Mission Complete!",id:"mission-complete",level:2}];function d(e){const t={blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",p:"p",strong:"strong",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Reaper-HTB-Sherlock",src:s(9764).A+"",width:"1024",height:"1024"})}),"\n",(0,a.jsx)(t.h2,{id:"lets-get-labbing",children:"Lets get Labbing"}),"\n",(0,a.jsx)(t.p,{children:"Okay so I just discovered Hack The Box Sherlocks, they are Blue Team focused labs that test your SOC Analyst skills. Useful for sharping and displaying knowledge and skills. There looks to be a lot of them which is great, so I decided to jump right in and take a stab at the first lab, a retired lab called Reaper."}),"\n",(0,a.jsx)(t.h2,{id:"reaper",children:"Reaper"}),"\n",(0,a.jsx)(t.p,{children:"So, I am on the page and ready to start. I proceeded to read through the scenario, which reads as follows:"}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:"Our SIEM alerted us to a suspicious logon event which needs to be looked at immediately . The alert details were that the IP Address and the Source Workstfation name were a mismatch .You are provided a network capture and event logs from the surrounding time around the incident timeframe. Corelate the given evidence and report back to your SOC Manager."}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"Then I downloaded the files for the lab and took a look at them. Here is what they look like:"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:s(7761).A+"",width:"795",height:"257"})}),"\n",(0,a.jsxs)(t.p,{children:["Okay so we have a ",(0,a.jsx)(t.code,{children:".evtx"})," file which is most likely a Windows Log file and also a ",(0,a.jsx)(t.code,{children:".pcapng"})," file that is a network capture of the event."]}),"\n",(0,a.jsxs)(t.p,{children:["Before I proceeded I was asking myself if I needed to spin up a Windows VM or this as the computer that I am using is running Ubuntu Linux. Also, during the Windows Event Log: Finding Evil module for the HTB CDSA, all ",(0,a.jsx)(t.code,{children:".etvw"})," files where opened using Windows tools like the Event Viewer, SilkETW, and the PowerShell cmd-let ",(0,a.jsx)(t.code,{children:"get-winevent"}),". Now I know there are most likely tools for viewing of these logs on Linux but, for posterity I will use the tools I learned about. Guess it's time to spin up that Windows VM."]}),"\n",(0,a.jsxs)(t.p,{children:["installed Gnome Boxes as I heard it was the most minimal type 2 hypervisor for Debian based Linux distros. Downloaded the latest Windows 10 ISO and completed the install. Landing at the desktop I installed spice-webav guest tools, this makes it easier to move files to and from the host to guest OS and vise versa. I also installed 7-Zip as the native Windows OS archive tool does not support password protected ",(0,a.jsx)(t.code,{children:".zip"})," files. WireShark was also installed on the machine for a nice GUI-based interface that I can use to filter and investigate the ",(0,a.jsx)(t.code,{children:".pcap"})," file mentioned above. And not bam, here we are at the desktop all ready to go all cyber detective and everything.\n",(0,a.jsx)(t.img,{src:s(1862).A+"",width:"1851",height:"1125"})]}),"\n",(0,a.jsx)(t.h2,{id:"task-1-what-is-the-ip-address-for-forela-wkstn001",children:"Task 1: What is the IP Address for Forela-Wkstn001?"}),"\n",(0,a.jsxs)(t.p,{children:["Okay, so the first question is asking us for the IP address of the computer hostname ",(0,a.jsx)(t.strong,{children:"Forela-Wkstn001"})," so most likely we will be looking at the pcap file as that contains all of the network monitoring logs, which contain details of connections to and from the network, protocols used, IP addresses, MAC addresses etc."]}),"\n",(0,a.jsxs)(t.p,{children:["Okay so with the pcap file open in WireShark and scrolling through without any filtering I can already see a log form the computer mentioned in the task info. Looks like the NetBios service running on our target machine was attempting to update information of some sort and we can clearly see the source IP address, which is ",(0,a.jsx)(t.code,{children:"172.17.79.129"}),"."]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:s(3740).A+"",width:"1851",height:"1125"})}),"\n",(0,a.jsx)(t.h3,{id:"what-is-netbios",children:"What is NetBios?"}),"\n",(0,a.jsxs)(t.p,{children:["NetBios is a network protocol that is used for layer 5 (OSI Model) communication over a local network, this communication happens between computers on the local network exchanging data like DNS info, printer sharing, and session management. It's a legacy protocol that was used heavily on older versions of Windows but, now not so much. Note that Linux does not natively use NetBios in it's networking stack but, most distros of Linux have access to a tool called ",(0,a.jsx)(t.code,{children:"netbios-utils"}),", a command-line utility for interacting with NetBios and other systems using it."]}),"\n",(0,a.jsx)(t.h2,{id:"task-2-what-is-the-ip-address-for-forela-wkstn002",children:"Task 2: What is the IP Address for Forela-Wkstn002?"}),"\n",(0,a.jsxs)(t.p,{children:["Task 2 is the same exact question but this time for computer ",(0,a.jsx)(t.strong,{children:"Forela-Wkstn002"}),". This time we will make use of WireSharks string search abilities.\n",(0,a.jsx)(t.img,{src:s(972).A+"",width:"1851",height:"1125"}),"\nAnd yet again we have more NetBios communication and the revealing of the source IP address of the machine, ",(0,a.jsx)(t.code,{children:"172.17.79.136"})]}),"\n",(0,a.jsx)(t.h2,{id:"task-3-which-user-accounts-hash-was-stolen-by-attacker",children:"Task 3: Which user account's hash was stolen by attacker?"}),"\n",(0,a.jsxs)(t.p,{children:["Task 3 is to figure out which account had its' hash stolen. Wondering if this could be related to the old NetBios protocol being used. If we look at the logs provided and filter for Windows Logon events, Event Code: ",(0,a.jsx)(t.code,{children:"4624"}),", the last 3 entries look very suspicious.\n",(0,a.jsx)(t.img,{src:s(6587).A+"",width:"1376",height:"952"}),"\nNow if we take a look at the event we can see what looks to be a malicious logon. How do we know it was malicious though? Well, we can see that the ",(0,a.jsx)(t.strong,{children:"Security ID, Account Name, Account Domain, and Logon ID"})," all look to be invalid values. Scrolling down further, we can see more indicators of compromise."]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:s(9062).A+"",width:"602",height:"252"})}),"\n",(0,a.jsxs)(t.p,{children:["Above we can see that a new user was logged on to, ",(0,a.jsx)(t.code,{children:"aurthur.kyle"})," from the Domain ",(0,a.jsx)(t.code,{children:"FORELA"}),". This is the first instance of this user logging on in the logs.\nAlso NTLM was used for the logon as you can see from the next image."]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:s(7405).A+"",width:"577",height:"203"})}),"\n",(0,a.jsx)(t.h3,{id:"what-is-ntlm",children:"What is NTLM"}),"\n",(0,a.jsx)(t.p,{children:"NTLM is another legacy protocol (lol, sensing a pattern here), that was originally developed in 1990's and was used by the Windows OS as an authentication protocol, it was specifically useful for authenticating systems and users in environments where the domain controller was not available."}),"\n",(0,a.jsx)(t.p,{children:"NTLM is also exploitable via Replay and Pass-The-Hash Attacks, and from the looks of it and taking into account the task question, I believe this is what took place."}),"\n",(0,a.jsx)(t.h2,{id:"task-4-what-is-the-ip-address-of-unknown-device-used-by-the-attacker-to-intercept-credentials",children:"Task 4: What is the IP Address of Unknown Device used by the attacker to intercept credentials?"}),"\n",(0,a.jsxs)(t.p,{children:["This one was easy as the same set of logs that we looked at from the previous task can be used to answer this one. The set of logons using NTLM and the user account ",(0,a.jsx)(t.code,{children:"arthur.kyle"})," all originated from the IP ",(0,a.jsx)(t.code,{children:"172.17.79.135"}),". This can be seen in the Network Information section of the provided windows log file and also in the PCAP file as well.\n",(0,a.jsx)(t.img,{src:s(5521).A+"",width:"1336",height:"450"})]}),"\n",(0,a.jsxs)(t.p,{children:["Filtering for the ",(0,a.jsx)(t.code,{children:"ntlmssp"})," protocol in Wireshark displays logs pertaining to NTLM negotiation and NTLM authentication.\n",(0,a.jsx)(t.img,{src:s(2257).A+"",width:"1167",height:"368"})]}),"\n",(0,a.jsx)(t.h2,{id:"task-5-what-was-the-fileshare-navigated-by-the-victim-user-account",children:"Task 5: What was the fileshare navigated by the victim user account?"}),"\n",(0,a.jsxs)(t.p,{children:["For this task I had already peeped that there were some events pertaining to SMB shares. ",(0,a.jsx)(t.em,{children:"I took a look at the hint for this one which read as follows:"})]}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:'Filter for smb2 traffic in wireshark. Search for keywords "BAD_NETWORK_NAME" in packet details.'}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:['Okay so lets filter for smb2 traffic. After applying the filter and scrolling down, I see the "BAD_NETWORK_NAME" string come up in a set of logs.\n',(0,a.jsx)(t.img,{src:s(9492).A+"",width:"1918",height:"1039"}),"\nThis reveals the SMB share that was navigated to, which was ",(0,a.jsx)(t.code,{children:"\\\\DCO01\\Trip"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"task-6-what-is-the-source-port-used-to-logon-to-target-workstation-using-the-compromised-account",children:"Task 6: What is the source port used to logon to target workstation using the compromised account?"}),"\n",(0,a.jsxs)(t.p,{children:["Another easy question as the information is contained in sections of both log files that we've looked at already. Image below shows the source port of the logon for the compromised account ",(0,a.jsx)(t.code,{children:"aurthur.kyle"}),".\n",(0,a.jsx)(t.img,{src:s(3624).A+"",width:"1284",height:"513"}),"\nAs we can see from the image above the source port for the malicious NTLM logon was port ",(0,a.jsx)(t.code,{children:"40252"}),", which is an ephemeral port, used for temporary outbound connections."]}),"\n",(0,a.jsx)(t.h2,{id:"task-7-what-is-the-logon-id-for-the-malicious-session",children:"Task 7: What is the Logon ID for the malicious session?"}),"\n",(0,a.jsxs)(t.p,{children:["This can also be found in the same event in the Windows Log file specifically in the ",(0,a.jsx)(t.em,{children:"New Logon"})," section.\n",(0,a.jsx)(t.img,{src:s(327).A+"",width:"1284",height:"513"}),"As you can see from the image, the Logon ID is ",(0,a.jsx)(t.code,{children:"0x64A799"})]}),"\n",(0,a.jsx)(t.h2,{id:"task-8-what-is-the-workstation-name-and-the-source-ip-address-from-which-the-malicious-logon-occur",children:"Task 8: What is the workstation name and the source IP Address from which the malicious logon occur?"}),"\n",(0,a.jsxs)(t.p,{children:["Task description also states that, ",(0,a.jsx)(t.em,{children:'"The detection was based on the mismatch of hostname and the assigned IP Address"'}),". Which I noticed as in the beginning tasks, we established that ",(0,a.jsx)(t.strong,{children:"Forela-Wkstn001"})," had an IP of ",(0,a.jsx)(t.strong,{children:"172.17.79.129"})," and that \xa0",(0,a.jsx)(t.strong,{children:"Forela-Wkstn002"})," had an IP of ",(0,a.jsx)(t.strong,{children:"172.17.79.136"}),". Looking at the log event for the malicious logon we find the following.\n",(0,a.jsx)(t.img,{src:s(2271).A+"",width:"1284",height:"513"}),"\nThe logon attempt happened on the ",(0,a.jsx)(t.strong,{children:"Forela-Wkstn002"})," machine but, from an IP address that is different, ",(0,a.jsx)(t.strong,{children:"172.17.79.135"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"task-9-when-did-the-malicious-logon-happened-please-make-sure-the-timestamp-is-in-utc",children:"Task 9: When did the malicious logon happened. Please make sure the timestamp is in UTC?"}),"\n",(0,a.jsx)(t.p,{children:"Alright, so same log event and this time a different set of data needed. Also, we must note that the task requests us to change the time to UTC so, depending on the machine your are viewing the logs on, and it's configured time zone, the time of the actual event will need to be adjusted to take this into account."}),"\n",(0,a.jsxs)(t.p,{children:["I like in the EST time zone so, the time of the event in EST was 12:55:16, converting that into UTC we get, 04:55:16.\n",(0,a.jsx)(t.img,{src:s(8886).A+"",width:"594",height:"386"}),"\nThe final complete answer, including the date as well as the time was ",(0,a.jsx)(t.code,{children:"2024-07-31 04:55:16"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"task-10-what-is-the-share-name-accessed-as-part-of-the-authentication-process-by-the-malicious-tool-used-by-the-attacker",children:"Task 10: What is the share Name accessed as part of the authentication process by the malicious tool used by the attacker?"}),"\n",(0,a.jsxs)(t.p,{children:["The last and final task of the Sherlock lab. The answer I saw in passing while browsing through the the log looking for answers to other tasks and getting the lay of the land in terms of what took place. I found that the  Windows event code for file shares is ",(0,a.jsx)(t.code,{children:"5140"})," after a quick google search. I applied the filter to the log file in Event Viewer and got the following.\n",(0,a.jsx)(t.img,{src:s(6938).A+"",width:"946",height:"620"}),"\nA single event that took place at the exact same time as the suspicious logon via NTLM, what a coincidence\ud83d\ude1d. The share accessed was ",(0,a.jsx)(t.code,{children:"\\\\*\\IPC$"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"mission-complete",children:"Mission Complete!"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:s(7941).A+"",width:"701",height:"617"})})]})}function l(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},9764:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/Reaper-Sherlock-738bd3ad7c5c6b744a142c477c3cd052.webp"},327:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/0456a9e3c13b5cd74a1967ed651db34f-9c5dac005047d86fa1d68c12575ac6f5.png"},2271:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/200f35380b7bb598dca2bc4b0f3fa5ba-e0d49b20f4405bf06f3ea0e3b7526ff4.png"},3740:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/2baa86df0ec002574a78804623f296bf-a98f261d88d5e0a8e059689ab119e176.png"},6587:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/5628302ed4d6d7911eb68b13d7dc8a4b-90182387052b925f75f5bdf10438555b.png"},5521:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/596162293f8ea3c7fb165eb296706bd6-8fefdf03b28f5f6b7450eed89280e6de.png"},7405:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/5ada28e45a3ca240117786bdd5453fc2-9bcd120d3d8e152c349b9042504940ed.png"},7941:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/6a30bc8d976c9615fd7efee1acdcf1d5-e1b8bbfbe495dd161ce12a7b8aa6d4f8.png"},9492:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/89291bdb3b10300a928f183ee28c7c1d-d8799a454aac6d7cc196893c0ca77f1b.png"},8886:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/a0b857537dd8f266f3ec5ed7ce0f49fa-07cf65f105b6166ab4e2c227265a3f37.png"},6938:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/a4d891b1bfb9cccbb8e7ff14668e271b-2e911044a5cff759252440230b9527c2.png"},9062:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/b8cec1843f18c156611acf8605e7745d-1e9275521125e1b1f6e02166c5f7a1dc.png"},3624:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/e008f3c11872b77051878ccfdb9cb6f9-e8d42eb7ec7aeae1a0a10bd85a9f457e.png"},2257:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/f3a1d58d866abb10150ad8ad63c2296d-4f7c632a84a1d7da10271545ef57e976.png"},972:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/f3c6ec58a5c134cc54cea1855ae1cf4e-5dba54d02e22d2b14d22d17eab248cc2.png"},7761:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/f3e9a82f7ba8eaa466cb4e55a410d4ea-e43a950c121f55a796427b86f2e8b895.png"},1862:(e,t,s)=>{s.d(t,{A:()=>a});const a=s.p+"assets/images/f58d94b49e61071a0c1a170e77e104e9-efbf3847c9590fb5ea58281146ede705.png"},8453:(e,t,s)=>{s.d(t,{R:()=>n,x:()=>h});var a=s(6540);const o={},i=a.createContext(o);function n(e){const t=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function h(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:n(e.components),a.createElement(i.Provider,{value:t},e.children)}}}]);